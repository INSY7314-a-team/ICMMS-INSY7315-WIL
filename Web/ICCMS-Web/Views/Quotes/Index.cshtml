@using ICCMS_Web.Models
@model List<Quote>
@{
    ViewData["Title"] = "Quotes";
}

<style>
  .muted{color:#6b7280}
  .chip{padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
  .chip.ok{background:#e8f5e9;color:#2e7d32}
  .chip.warn{background:#fff8e1;color:#b26a00}
  .chip.danger{background:#ffebee;color:#c62828}
  .btn-brand{background:#FFD200;border-color:#FFD200;color:#111}
  .btn-brand:hover{filter:brightness(.95)}
  .table-sm td, .table-sm th{vertical-align:middle}
</style>

<div class="container-fluid px-3 px-md-4 py-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h3 fw-bold mb-1">Quotes</h1>
      <div class="muted">All quotes you've created from the PM dashboard</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-brand" id="btn-new-quote">
        <i class="fas fa-file-invoice"></i> Create New Quote
      </button>
    </div>
  </div>

  @if (TempData["ok"] != null)
  {
    <div class="alert alert-success">@TempData["ok"]</div>
  }

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Client</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          @foreach (var q in Model)
          {
              string chipClass = (q.Status ?? "Draft").ToLower() switch {
                  "accepted" => "chip ok",
                  "sent"     => "chip warn",
                  "waiting approval" => "chip warn",
                  "rejected" => "chip danger",
                  "rejected & reopened" => "chip danger",
                  _          => "chip"
              };

              // detect if this quote was replaced by another
              bool reopenedOld = Model.Any(x => x.OriginalQuoteId == q.Id);

              <tr>
                <td>@q.Id</td>
                <td>@q.Title</td>
                <td>@q.ClientName</td>
                <td><span class="@chipClass">@q.Status</span></td>
                <td>@(q.Status == "Rejected" ? q.RejectionReason ?? "—" : "—")</td>
                <td>@(q.Items?.Count ?? 0)</td>
                <td>R @q.Total.ToString("N2")</td>
                <td>
                    @* Case 1: old quote that was reopened *@
                    @if (reopenedOld)
                    {
                        <span class="badge bg-danger">Rejected &amp; Reopened</span>
                    }
                    @* Case 2: freshly rejected (can be reopened) *@
                    else if (q.Status == "Rejected")
                    {
                        <a href="#" class="btn btn-sm btn-outline-warning btn-reopen" data-id="@q.Id">Reopen</a>
                    }
                    @* Case 3: waiting approval (including reopened copies) *@
                    else if (q.Status == "Waiting Approval")
                    {
                        <a asp-controller="Quotes" asp-action="Accept" asp-route-id="@q.Id"
                           class="btn btn-sm btn-outline-success">Accept</a>
                        <a href="#" class="btn btn-sm btn-outline-danger btn-reject" data-id="@q.Id">Reject</a>
                    }
                    @* Case 4: accepted *@
                    else if (q.Status == "Accepted")
                    {
                        <span class="badge bg-success">Accepted</span>
                    }
                </td>
              </tr>
          }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- NEW QUOTE WIZARD -->
@await Html.PartialAsync("~/Views/Shared/_QuoteWizard.cshtml")

<!-- Hidden Preview POST form -->
<form id="quote-preview-form" method="post" asp-controller="Quotes" asp-action="Preview" target="_blank" class="d-none">
  @Html.AntiForgeryToken()
</form>

<script>
// Reopen button
document.querySelectorAll('.btn-reopen').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const id = btn.dataset.id;
    console.log("[Reopen] clicked for ID:", id);

    const res = await fetch(`/Quotes/Get?id=${id}`);
    console.log("[Reopen] fetch status:", res.status);

    if (res.ok) {
      const q = await res.json();
      console.log("[Reopen] fetched quote:", q);

      // hydrate wizard
      window.hydrateQuote(q);

      // inject hidden OriginalQuoteId
      const form = document.getElementById('quote-preview-form');
      if (form) {
        form.querySelectorAll('input[name="OriginalQuoteId"]').forEach(x => x.remove());
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'OriginalQuoteId';
        input.value = q.id;
        form.appendChild(input);

        console.log("[Reopen] hidden input injected:", input);
      }
    } else {
      console.error("[Reopen] fetch failed for", id);
    }
  });
});

// Reject button
document.querySelectorAll('.btn-reject').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const id = btn.dataset.id;
    console.log("[Reject] clicked for ID:", id);

    const reason = prompt("Please enter a rejection reason:");
    console.log("[Reject] reason entered:", reason);

    if (!reason) {
      console.warn("[Reject] cancelled (no reason entered)");
      return;
    }

    try {
      const res = await fetch(`/Quotes/Reject?id=${id}&reason=${encodeURIComponent(reason)}`);
      console.log("[Reject] fetch status:", res.status);

      if (res.ok) {
        const data = await res.json();
        console.log("[Reject] server response:", data);
        location.reload();
      } else {
        console.error("[Reject] server returned non-OK status:", res.status);
      }
    } catch (err) {
      console.error("[Reject] fetch error:", err);
    }
  });
});
</script>

<!-- Boot flags for JS -->
<script>window.PM = { root: '@Url.Content("~/")', QUOTE_ONLY: true };</script>
