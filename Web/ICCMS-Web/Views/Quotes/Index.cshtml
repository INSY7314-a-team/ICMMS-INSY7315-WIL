@using ICCMS_Web.Models
@model List<Quote>
@{
    ViewData["Title"] = "Quotes";
}

<style>
  .muted{color:#6b7280}
  .chip{padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
  .chip.ok{background:#e8f5e9;color:#2e7d32}
  .chip.warn{background:#fff8e1;color:#b26a00}
  .chip.danger{background:#ffebee;color:#c62828}
  .btn-brand{background:#FFD200;border-color:#FFD200;color:#111}
  .btn-brand:hover{filter:brightness(.95)}
  .table-sm td, .table-sm th{vertical-align:middle}
</style>

<div class="container-fluid px-3 px-md-4 py-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h3 fw-bold mb-1">Quotes</h1>
      <div class="muted">All quotes you've created from the PM dashboard</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-brand" id="btn-new-quote">
        <i class="fas fa-file-invoice"></i> Create New Quote
      </button>
    </div>
  </div>

  @if (TempData["ok"] != null)
  {
    <div class="alert alert-success">@TempData["ok"]</div>
  }

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Client</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          @foreach (var q in Model)
          {
              string chipClass = (q.Status ?? "Draft").ToLower() switch {
                  "accepted" => "chip ok",
                  "sent"     => "chip warn",
                  "rejected" => "chip danger",
                  _          => "chip"
              };
              <tr>
                <td>@q.Id</td>
                <td>@q.Title</td>
                <td>@q.ClientName</td>
                <td><span class="@chipClass">@q.Status</span></td>
                <td>@(q.Status == "Rejected" ? q.RejectionReason ?? "—" : "—")</td>
                <td>@(q.Items?.Count ?? 0)</td>
                <td>R @q.Total.ToString("N2")</td>
                <td>
                  @if (q.Status == "Rejected")
                  {
                      <a asp-controller="Quotes" asp-action="Edit" asp-route-id="@q.Id" 
                         class="btn btn-sm btn-outline-warning">
                        Reopen
                      </a>
                  }
                  else if (q.Status == "Accepted")
                  {
                      <span class="badge bg-success">Accepted</span>
                  }
                  else
                  {
                      <a asp-controller="Quotes" asp-action="Send" asp-route-id="@q.Id"
                         class="btn btn-sm btn-outline-secondary">Send</a>
                  }
                </td>
              </tr>
          }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- NEW QUOTE WIZARD -->
@await Html.PartialAsync("~/Views/Shared/_QuoteWizard.cshtml")

<!-- Hidden Preview POST form -->
<form id="quote-preview-form" method="post" asp-controller="Quotes" asp-action="Preview" target="_blank" class="d-none">
  @Html.AntiForgeryToken()
</form>

<!-- Boot flags for JS -->
<script>window.PM = { root: '@Url.Content("~/")', QUOTE_ONLY: true };</script>
<script src="~/js/pm/pm-quote.js"></script>
