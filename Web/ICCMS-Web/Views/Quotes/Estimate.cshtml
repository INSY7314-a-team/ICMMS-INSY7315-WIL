@model ICCMS_Web.Models.EstimateViewModel

@{
    ViewData["Title"] = "Estimate Quotation";
    Layout = "_Layout";
}

<div class="container my-4">
    <h2 class="fw-bold mb-4">Estimate Quotation</h2>
    <p>DEBUG QuotationId: @Model.QuotationId</p>

    <!-- Draft Quotation Details -->
    <div class="card p-3 mb-4">
        <h5 class="mb-3">Draft Quotation Details</h5>
        <p><strong>Project:</strong> @Model.ProjectName</p>
        <p><strong>Client:</strong> @Model.ClientName</p>
        <p><strong>Description:</strong> @Model.Description</p>
    </div>

    <!-- Validation summary -->
    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

    <form asp-controller="Quotes" asp-action="Estimate" asp-route-id="@Model.QuotationId" method="post" onsubmit="return validateEstimateForm();">
        @Html.AntiForgeryToken()
        
        <!-- Hidden IDs -->
        <input type="hidden" name="ProjectId" value="@Model.ProjectId" />
        <input type="hidden" name="QuotationId" value="@Model.QuotationId" />
        <input type="hidden" name="ClientId" value="@Model.ClientId" />
        <input type="hidden" name="ContractorId" value="@Model.ContractorId" />
        <input type="hidden" asp-for="Description" />


        <!-- AI Blueprint Section -->
        <div class="card p-3 mb-3">
            <h5 class="mb-3">AI Blueprint Processing</h5>
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label">Blueprint URL</label>
                    <input type="text" id="blueprintUrl" class="form-control" placeholder="Enter blueprint URL" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-outline-info w-100" onclick="processBlueprint('@Model.QuotationId')">
                        <i class="fas fa-robot me-1"></i> Auto-fill from Blueprint
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Accept/Remove -->
        <div id="aiControls" class="alert alert-info justify-content-between align-items-center" style="display:none;">
            <span><i class="fas fa-magic me-2"></i>AI auto-filled items detected. Accept or remove?</span>
            <div>
                <button type="button" class="btn btn-success btn-sm me-2" onclick="acceptAiItems()">Accept</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAiItems()">Remove</button>
            </div>
        </div>

        <!-- Items Table -->
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th style="width:90px">Unit</th>
                    <th style="width:100px">Qty</th>
                    <th style="width:120px">Unit Price</th>
                    <th style="width:120px">Line Total</th>
                    <th>Notes</th>
                    <th style="width:90px">AI</th>
                    <th style="width:60px">Remove</th>
                </tr>
            </thead>
            <tbody id="itemsTable">
                <!-- Items injected via JS -->
            </tbody>
        </table>
        <div class="text-danger validation-error-items"></div> <!-- Inline validation container for items -->

        <!-- Add Line Item Button -->
        <div class="mb-3">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLineItem()">
                âž• Add Line Item
            </button>
        </div>

        <!-- Totals -->
        <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between">
                <span>Subtotal</span>
                <span id="subtotalDisplay">
                    @Model.Subtotal.ToString("C", System.Globalization.CultureInfo.CreateSpecificCulture("en-ZA"))
                </span>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2">
                <span>Tax (%)</span>
                <div class="d-flex align-items-center">
                    <input asp-for="TaxRate" id="taxRateInput" type="number" step="0.01" class="form-control me-2" style="width:80px;" />
                    <span id="taxDisplay">
                        @Model.TaxAmount.ToString("C", System.Globalization.CultureInfo.CreateSpecificCulture("en-ZA"))
                    </span>
                </div>
                <span class="text-danger">@Html.ValidationMessageFor(m => m.TaxRate)</span>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2">
                <span>Markup (%)</span>
                <div class="d-flex align-items-center">
                    <input asp-for="MarkupRate" id="markupRateInput" type="number" step="0.01" class="form-control me-2" style="width:80px;" />
                    <span id="markupDisplay">
                        @Model.MarkupAmount.ToString("C", System.Globalization.CultureInfo.CreateSpecificCulture("en-ZA"))
                    </span>
                </div>
                <span class="text-danger">@Html.ValidationMessageFor(m => m.MarkupRate)</span>
            </div>

            <hr />
            <div class="d-flex justify-content-between fw-bold">
                <span>Grand Total</span>
                <span id="grandTotalDisplay">
                    @Model.GrandTotal.ToString("C", System.Globalization.CultureInfo.CreateSpecificCulture("en-ZA"))
                </span>
            </div>
        </div>

        <!-- Save -->
        <button type="submit" class="btn btn-primary" onclick="return validateEstimateForm()">Save & Continue</button>

    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const preloadedItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Items));
            if (preloadedItems && preloadedItems.length > 0) {
                renderLineItems(preloadedItems, false);
            }
        });
    </script>
    <script src="~/js/estimate.js"></script>
    <partial name="_ValidationScriptsPartial" />
}
