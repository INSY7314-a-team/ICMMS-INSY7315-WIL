@model ICCMS_Web.Models.ContractorDashboardViewModel
@{
    ViewData["Title"] = "Contractor Dashboard";
    Layout = "_Layout";
}

@await Html.PartialAsync("_TaskDetailsModal")
@await Html.PartialAsync("_ProgressReportModal")
@await Html.PartialAsync("_CompletionRequestModal")

<div class="contractor-dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fa-solid fa-hard-hat me-2" style="color: #F7EC59;"></i>@User.Identity.Name Dashboard
        </h1>
        <p class="dashboard-subtitle">Welcome back, @User.Identity.Name! Manage your assigned tasks and track progress
        </p>
    </div>

    <!-- Stats Summary Cards -->
    <div class="stats-container">
        <div class="row g-2 mb-3">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.TotalTasks</h4>
                        <p class="stat-label">Total</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon pending">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.PendingTasks</h4>
                        <p class="stat-label">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon in-progress">
                        <i class="fa-solid fa-play"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.InProgressTasks</h4>
                        <p class="stat-label">In Progress</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon completed">
                        <i class="fa-solid fa-circle-check"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.CompletedTasks</h4>
                        <p class="stat-label">Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon overdue">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.OverdueTasks</h4>
                        <p class="stat-label">Overdue</p>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Projects Section -->
    <div class="main-projects-section">
        @* <div class="section-header construction-border-thin"> *@
        <div class="section-header-content">
            <h3 class="section-title">
                <i class="fa-solid fa-folder-open me-2"></i>My Projects
                <span class="badge bg-secondary">@(Model?.Projects?.Count ?? 0)</span>
            </h3>
            <div class="section-actions">
                <div class="sort-controls">
                    <label for="projectSortBy" class="sort-label">Sort by</label>
                    <select id="projectSortBy" class="dashboard-select">
                        <option value="name">Project Name</option>
                        <option value="progress">Progress</option>
                        <option value="budget">Budget</option>
                        <option value="tasks">Number of Tasks</option>
                        <option value="overdue">Overdue Tasks</option>
                    </select>
                </div>
                <button class="dashboard-btn" id="refreshProjectsBtn">
                    <i class="fa-solid fa-arrows-rotate"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <div id="projectsContainer" class="projects-container">
        @await Html.PartialAsync("_ProjectsList", Model?.Projects ?? new List<ContractorProjectCardDto>())
    </div>
</div>

<!-- Include dashboard CSS directly -->
<link rel="stylesheet" href="~/css/contractor-dashboard.css" />
<link rel="stylesheet" href="~/css/contractor-task-cards.css" />
<link rel="stylesheet" href="~/css/contractor-collapsible-tasks.css" />
<link rel="stylesheet" href="~/css/contractor-project-cards.css" />

@section Scripts {
    <script src="~/js/contractor-dashboard.js"></script>
    <script src="~/js/contractor-task-actions.js"></script>
    <script src="~/js/contractor-collapsible-tasks.js"></script>
    <script src="~/js/contractor-project-cards.js"></script>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            initializeContractorDashboard();
        });

        function toggleFilters() {
            const panel = document.getElementById('filtersPanel');
            function toggleFilters() {
                const panel = document.getElementById('filtersPanel');
                const toggleText = document.getElementById('filterToggleText');
                const toggleIcon = document.getElementById('filterToggleIcon');
                if (!panel || !toggleText || !toggleIcon) return;

                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    toggleText.textContent = 'Hide Filters';
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                } else {
                    panel.style.display = 'none';
                    toggleText.textContent = 'Show Filters';
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                }
            } try {
                const status = document.querySelector('.status-filter-btn.active')?.getAttribute('data-status') || '';
                const startDateFrom = document.getElementById('startDateFrom')?.value || '';
                const startDateTo = document.getElementById('startDateTo')?.value || '';
                const dueDateFrom = document.getElementById('dueDateFrom')?.value || '';
                const dueDateTo = document.getElementById('dueDateTo')?.value || '';
                const sortBy = document.getElementById('sortBy')?.value || '';
                const sortOrder = document.getElementById('sortOrder')?.value || '';

                const params = new URLSearchParams();
                if (status && status !== 'All') params.set('status', status);
                if (startDateFrom) params.set('startDateFrom', startDateFrom);
                if (startDateTo) params.set('startDateTo', startDateTo);
                if (dueDateFrom) params.set('dueDateFrom', dueDateFrom);
                if (dueDateTo) params.set('dueDateTo', dueDateTo);
                if (sortBy) params.set('sortBy', sortBy);
                if (sortOrder) params.set('sortOrder', sortOrder);

                const baseUrl = '@Url.Action("GetAssignedTasks", "Contractor")';
                const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Filter failed');
                const tasks = await res.json();

                // Update task grid
                const tasksGrid = document.getElementById('tasksGrid');
                if (tasksGrid) {
                    // Render tasks using the same partial
                    // This would need to be implemented with server-side rendering
                    console.log('Filtered tasks:', tasks);
                }
            } catch (e) {
                console.error('Filter error:', e);
                showToast('Failed to apply filters', 'error');
            }
        }

        async function clearAdvancedFilters() {
            const startDateFromEl = document.getElementById('startDateFrom');
            const startDateToEl = document.getElementById('startDateTo');
            const dueDateFromEl = document.getElementById('dueDateFrom');
            const dueDateToEl = document.getElementById('dueDateTo');
            const sortByEl = document.getElementById('sortBy');
            const sortOrderEl = document.getElementById('sortOrder');

            if (startDateFromEl) startDateFromEl.value = '';
            if (startDateToEl) startDateToEl.value = '';
            if (dueDateFromEl) dueDateFromEl.value = '';
            if (dueDateToEl) dueDateToEl.value = '';
            if (sortByEl) sortByEl.value = 'dueDate';
            if (sortOrderEl) sortOrderEl.value = 'asc';

            // Remove active status filter
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            try {
                const baseUrl = '@Url.Action("GetAssignedTasks", "Contractor")';
                const res = await fetch(baseUrl);
                if (!res.ok) throw new Error('Clear filters failed');
                const tasks = await res.json();
                console.log('All tasks:', tasks);
            } catch (e) {
                console.error('Clear filters error:', e);
            }
        }

        // Toast functionality removed - using console logging instead
        function showToast(message, type = 'info') {
            console.log(`ðŸ“¢ ${type.toUpperCase()}: ${message}`);
        }
    </script>
}
