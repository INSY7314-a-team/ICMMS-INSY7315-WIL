<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">
                    <i class="fa-solid fa-clipboard-list me-2"></i>Task Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Task Information</h6>
                        <div class="task-info">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Task Name</label>
                                <div id="modalTaskName" class="form-control-plaintext">Loading...</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Project</label>
                                <div id="modalProjectName" class="form-control-plaintext">Loading...</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Description</label>
                                <div id="modalTaskDescription" class="form-control-plaintext">Loading...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Timeline & Status</h6>
                        <div class="task-timeline">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Start Date</label>
                                <div id="modalStartDate" class="form-control-plaintext">Loading...</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Due Date</label>
                                <div id="modalDueDate" class="form-control-plaintext">Loading...</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <div id="modalTaskStatus" class="form-control-plaintext">Loading...</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Priority</label>
                                <div id="modalTaskPriority" class="form-control-plaintext">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">Progress Tracking</h6>
                        <div class="progress-section">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="progress-item">
                                        <label class="form-label fw-bold">Task Progress</label>
                                        <div class="progress mb-2">
                                            <div id="modalTaskProgress" class="progress-bar" role="progressbar"
                                                style="width: 0%"></div>
                                        </div>
                                        <small id="modalTaskProgressText" class="text-muted">0%</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="progress-item">
                                        <label class="form-label fw-bold">Hours Worked</label>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="progress mb-2">
                                                    <div id="modalHoursProgress" class="progress-bar bg-info"
                                                        role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <small id="modalHoursText" class="text-muted">0 / 0 hours</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="progress-item">
                                        <label class="form-label fw-bold">Project Budget</label>
                                        <div id="modalProjectBudget"
                                            class="form-control-plaintext fw-bold text-success">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Reports Timeline -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">Progress Reports</h6>
                        <div id="modalProgressReports" class="progress-reports-timeline">
                            <div class="text-center text-muted">
                                <i class="fa-solid fa-spinner fa-spin"></i> Loading progress reports...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitProgressBtn"
                    onclick="openProgressReportModal()">
                    <i class="fa-solid fa-file-lines me-1"></i>Submit Progress
                </button>
                <button type="button" class="btn btn-success" id="requestCompletionBtn"
                    onclick="openCompletionRequestModal()">
                    <i class="fa-solid fa-check me-1"></i>Request Completion
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentTaskId = null;

    function openTaskDetailsModal(taskId) {
        currentTaskId = taskId;
        const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        modal.show();

        // Load task details
        loadTaskDetailsForModal(taskId);
    }

    function loadTaskDetailsForModal(taskId) {
        fetch(`/Contractor/GetTaskDetails?taskId=${encodeURIComponent(taskId)}`)
            .then(response => response.json())
            .then(task => {
                if (task) {
                    // Update task information
                    document.getElementById('modalTaskName').textContent = task.name;
                    document.getElementById('modalProjectName').textContent = task.projectName;
                    document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
                    document.getElementById('modalStartDate').textContent = new Date(task.startDate).toLocaleDateString();
                    document.getElementById('modalDueDate').textContent = new Date(task.dueDate).toLocaleDateString();
                    // Safe DOM creation for status badge
                    const statusElement = document.getElementById('modalTaskStatus');
                    statusElement.innerHTML = ''; // Clear existing content
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `badge ${mapStatusToBadge(task.status)}`;
                    statusSpan.textContent = String(task.status || 'Unknown');
                    statusElement.appendChild(statusSpan);

                    // Safe DOM creation for priority badge
                    const priorityElement = document.getElementById('modalTaskPriority');
                    priorityElement.innerHTML = ''; // Clear existing content
                    const prioritySpan = document.createElement('span');
                    prioritySpan.className = `badge ${mapPriorityToClass(task.priority)}`;
                    prioritySpan.textContent = String(task.priority || 'Unknown');
                    priorityElement.appendChild(prioritySpan);

                    // Update progress
                    document.getElementById('modalTaskProgress').style.width = `${task.progress}%`;
                    document.getElementById('modalTaskProgressText').textContent = `${task.progress}%`;

                    // Update hours
                    const hoursPercent = task.estimatedHours > 0 ? (task.actualHours / task.estimatedHours * 100) : 0;
                    document.getElementById('modalHoursProgress').style.width = `${hoursPercent}%`;
                    document.getElementById('modalHoursText').textContent = `${task.actualHours} / ${task.estimatedHours} hours`;

                    // Update budget
                    document.getElementById('modalProjectBudget').textContent = `R ${task.projectBudget?.toLocaleString() || '0'}`;

                    // Update action buttons visibility
                    updateActionButtons(task);

                    // Load progress reports
                    loadProgressReportsForModal(taskId);
                }
            })
            .catch(error => {
                console.error('Failed to load task details:', error);
                showToast('Failed to load task details', 'error');
            });
    }

    function updateActionButtons(task) {
        const submitProgressBtn = document.getElementById('submitProgressBtn');
        const requestCompletionBtn = document.getElementById('requestCompletionBtn');

        // Hide all buttons first
        submitProgressBtn.style.display = 'none';
        requestCompletionBtn.style.display = 'none';

        // Show appropriate buttons based on task status
        if (task.canSubmitProgress) {
            submitProgressBtn.style.display = 'inline-block';
        }
        if (task.canRequestCompletion) {
            requestCompletionBtn.style.display = 'inline-block';
        }
    }

    function loadProgressReportsForModal(taskId) {
        const container = document.getElementById('modalProgressReports');

        fetch(`/Contractor/GetProgressReports?taskId=${encodeURIComponent(taskId)}`)
            .then(response => response.json())
            .then(reports => {
                if (reports && reports.length > 0) {
                    container.innerHTML = renderProgressReportsTimeline(reports);
                } else {
                    container.innerHTML = '<div class="text-muted text-center py-3">No progress reports submitted yet</div>';
                }
            })
            .catch(error => {
                console.error('Failed to load progress reports:', error);
                container.innerHTML = '<div class="text-danger text-center py-3">Failed to load progress reports</div>';
            });
    }

    function renderProgressReportsTimeline(reports) {
        return reports.map((report, index) => {
            const statusClass = report.status === 'Approved' ? 'success' :
                report.status === 'Rejected' ? 'danger' : 'warning';
            const statusIcon = report.status === 'Approved' ? 'fa-check-circle' :
                report.status === 'Rejected' ? 'fa-times-circle' : 'fa-clock';

            return `
                <div class="timeline-item mb-3 p-3 border rounded position-relative">
                    <div class="timeline-marker position-absolute top-0 start-0 translate-middle">
                        <i class="fa-solid fa-circle text-${statusClass}"></i>
                    </div>
                    <div class="timeline-content ms-4">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${escapeHtml(report.description || 'No description')}</h6>
                                <small class="text-muted">
                                    <i class="fa-solid fa-clock me-1"></i>
                                    Submitted: ${new Date(report.submittedAt).toLocaleDateString()}
                                </small>
                            </div>
                            <span class="badge bg-${statusClass}">
                                <i class="fa-solid ${statusIcon} me-1"></i>${report.status}
                            </span>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-3">
                                <small class="text-muted">Hours Worked:</small>
                                <div class="fw-bold">${report.hoursWorked}</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Documents:</small>
                                <div class="fw-bold">${report.attachedDocumentIds?.length || 0}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Submitted By:</small>
                               <div class="fw-bold">${escapeHtml(report.submittedBy || '')}</div>
                            </div>                        </div>
                        ${report.reviewNotes ? `
                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">Review Notes:</small>
                                <div class="small">${escapeHtml(report.reviewNotes)}</div>
                            </div>
                        ` : ''}
                        ${report.reviewedAt ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    Reviewed: ${new Date(report.reviewedAt).toLocaleDateString()}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function openProgressReportModal() {
        if (currentTaskId) {
            // Close current modal
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('taskDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }

            // Open progress report modal
            setTimeout(() => {
                openProgressReportModal(currentTaskId);
            }, 300);
        }
    }

    function openCompletionRequestModal() {
        if (currentTaskId) {
            // Close current modal
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('taskDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }

            // Open completion request modal
            setTimeout(() => {
                openCompletionRequestModal(currentTaskId);
            }, 300);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Safe status to badge class mapping
    function mapStatusToBadge(status) {
        const statusStr = String(status || '').toLowerCase();
        const statusMap = {
            'pending': 'bg-warning',
            'in progress': 'bg-primary',
            'in-progress': 'bg-primary',
            'completed': 'bg-success',
            'cancelled': 'bg-danger',
            'cancelled': 'bg-danger',
            'on hold': 'bg-secondary',
            'on-hold': 'bg-secondary',
            'review': 'bg-info',
            'approved': 'bg-success',
            'rejected': 'bg-danger'
        };
        return statusMap[statusStr] || 'bg-secondary'; // Default safe class
    }

    // Safe priority to CSS class mapping
    function mapPriorityToClass(priority) {
        const priorityStr = String(priority || '').toLowerCase();
        const priorityMap = {
            'low': 'priority-low',
            'medium': 'priority-medium',
            'high': 'priority-high',
            'urgent': 'priority-urgent',
            'critical': 'priority-critical'
        };
        return priorityMap[priorityStr] || 'priority-medium'; // Default safe class
    }

    // Toast functionality removed - using console logging instead
    function showToast(message, type = 'info') {
        console.log(`ðŸ“¢ ${type.toUpperCase()}: ${message}`);
    }
</script>
