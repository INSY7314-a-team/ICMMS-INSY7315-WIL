<!-- Completion Request Modal -->
<div class="modal fade" id="completionRequestModal" tabindex="-1" aria-labelledby="completionRequestModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completionRequestModalLabel">
                    <i class="fa-solid fa-check-circle me-2"></i>Request Task Completion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Task Context -->
                <div class="task-context mb-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">Task Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Task:</strong> <span id="modalTaskName">Loading...</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Project:</strong> <span id="modalProjectName">Loading...</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>Description:</strong> <span id="modalTaskDescription">Loading...</span>
                    </div>
                </div>

                <!-- Completion Request Form -->
                <form id="completionRequestForm">
                    <input type="hidden" id="completionRequestTaskId" name="taskId" />

                    <div class="mb-3">
                        <label for="completionNotes" class="form-label fw-bold">
                            <i class="fa-solid fa-comment me-1"></i>Completion Summary <span
                                class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="completionNotes" name="notes" rows="4"
                            placeholder="Provide a detailed summary of the completed work, including any final deliverables, quality checks performed, and confirmation that all requirements have been met."
                            required></textarea>
                        <div class="form-text">This summary will be reviewed by your project manager before final
                            approval.</div>
                    </div>

                    <div class="mb-3">
                        <label for="completionDocuments" class="form-label fw-bold">
                            <i class="fa-solid fa-paperclip me-1"></i>Final Completion Documents <span
                                class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" id="completionDocuments" name="documents" multiple
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.dwg" required>
                        <div class="form-text">
                            Upload final photos, completion certificates, quality reports, or other documents that prove
                            task completion.
                            At least one document is required.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="finalHours" class="form-label fw-bold">
                            <i class="fa-solid fa-clock me-1"></i>Final Hours Worked
                        </label>
                        <input type="number" class="form-control" id="finalHours" name="finalHours" min="0.1" step="0.1"
                            placeholder="0.0">
                        <div class="form-text">Total hours worked on this task (if different from previous reports).
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="qualityChecklist" class="form-label fw-bold">
                            <i class="fa-solid fa-clipboard-check me-1"></i>Quality Checklist
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="qualityStandards"
                                name="qualityStandards" required>
                            <label class="form-check-label" for="qualityStandards">
                                I confirm that the work meets all quality standards and specifications
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="safetyCompliance"
                                name="safetyCompliance" required>
                            <label class="form-check-label" for="safetyCompliance">
                                I confirm that all safety protocols were followed during the work
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="clientSatisfaction"
                                name="clientSatisfaction" required>
                            <label class="form-check-label" for="clientSatisfaction">
                                I confirm that the client requirements have been fully satisfied
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="completionDate" class="form-label fw-bold">
                            <i class="fa-solid fa-calendar me-1"></i>Actual Completion Date
                        </label>
                        <input type="date" class="form-control" id="completionDate" name="completionDate"
                            value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        <div class="form-text">The actual date when the work was completed.</div>
                    </div>

                    <!-- Document Preview -->
                    <div id="completionDocumentPreview" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Selected Documents</label>
                        <div id="completionDocumentList" class="list-group"></div>
                    </div>

                    <!-- Confirmation -->
                    <div class="alert alert-warning">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> Once submitted, this completion request will be sent to your project
                        manager for review and approval.
                        The task will remain in "Awaiting Approval" status until approved.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" id="submitCompletionRequestBtn"
                    onclick="submitCompletionRequest()">
                    <i class="fa-solid fa-paper-plane me-1"></i>Submit Completion Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function openCompletionRequestModal(taskId) {
        const modal = new bootstrap.Modal(document.getElementById('completionRequestModal'));
        modal.show();

        // Set task ID
        document.getElementById('completionRequestTaskId').value = taskId;

        // Load task details
        loadTaskDetailsForCompletionModal(taskId);

        // Reset form
        document.getElementById('completionRequestForm').reset();
        document.getElementById('completionDocumentPreview').style.display = 'none';
        document.getElementById('completionDocumentList').innerHTML = '';

        // Set default completion date to today
        document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
    }

    function loadTaskDetailsForCompletionModal(taskId) {
        fetch(`/Contractor/GetTaskDetails?taskId=${encodeURIComponent(taskId)}`)
            .then(response => response.json())
            .then(task => {
                if (task) {
                    document.getElementById('modalTaskName').textContent = task.name;
                    document.getElementById('modalProjectName').textContent = task.projectName;
                    document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
                }
            })
            .catch(error => {
                console.error('Failed to load task details:', error);
            });
    }

    function submitCompletionRequest() {
        const form = document.getElementById('completionRequestForm');
        const formData = new FormData(form);

        // Validate required fields
        const notes = document.getElementById('completionNotes').value.trim();
        const documents = document.getElementById('completionDocuments').files;

        if (!notes) {
            showToast('Please provide a completion summary', 'error');
            return;
        }

        if (documents.length === 0) {
            showToast('Please upload at least one completion document', 'error');
            return;
        }

        // Validate checkboxes
        const qualityStandards = document.getElementById('qualityStandards').checked;
        const safetyCompliance = document.getElementById('safetyCompliance').checked;
        const clientSatisfaction = document.getElementById('clientSatisfaction').checked;

        if (!qualityStandards || !safetyCompliance || !clientSatisfaction) {
            showToast('Please confirm all quality checklist items', 'error');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitCompletionRequestBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Submitting...';
        submitBtn.disabled = true;

        // Prepare completion request data
        const completionRequest = {
            taskId: formData.get('taskId'),
            notes: notes,
            completionDate: formData.get('completionDate'),
            finalHours: parseFloat(formData.get('finalHours')) || 0,
            qualityStandards: qualityStandards,
            safetyCompliance: safetyCompliance,
            clientSatisfaction: clientSatisfaction,
            documentId: null // Will be populated after document upload
        };

        // Submit completion request
        fetch('/Contractor/RequestCompletion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(completionRequest)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Completion request submitted successfully! Your project manager will review it shortly.', 'success');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('completionRequestModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // Refresh task card
                    refreshTaskCard(completionRequest.taskId);
                } else {
                    showToast('Failed to submit completion request: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting completion request:', error);
                showToast('An error occurred while submitting the completion request', 'error');
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    }

    function refreshTaskCard(taskId) {
        // Reload the task card to show updated information
        const taskCard = document.getElementById(`task-${taskId}`);
        if (taskCard) {
            // Trigger a page refresh or reload the task data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }

    // Document preview functionality
    document.getElementById('completionDocuments').addEventListener('change', function (e) {
        const files = Array.from(e.target.files);
        const preview = document.getElementById('completionDocumentPreview');
        const list = document.getElementById('completionDocumentList');

        if (files.length > 0) {
            preview.style.display = 'block';
            list.innerHTML = '';

            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <i class="fa-solid fa-file me-2"></i>
                        <span>${file.name}</span>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCompletionDocument(${index})">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        } else {
            preview.style.display = 'none';
        }
    });

    function removeCompletionDocument(index) {
        const input = document.getElementById('completionDocuments');
        const dt = new DataTransfer();
        const files = Array.from(input.files);

        files.forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });

        input.files = dt.files;
        input.dispatchEvent(new Event('change'));
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    }
</script>
