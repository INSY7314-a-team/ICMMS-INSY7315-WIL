<!-- Progress Report Modal -->
<div class="modal fade" id="progressReportModal" tabindex="-1" aria-labelledby="progressReportModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressReportModalLabel">
                    <i class="fa-solid fa-file-lines me-2"></i>Submit Progress Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Task Context -->
                <div class="task-context mb-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">Task Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Task:</strong> <span id="modalTaskName">Loading...</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Project:</strong> <span id="modalProjectName">Loading...</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>Description:</strong> <span id="modalTaskDescription">Loading...</span>
                    </div>
                </div>

                <!-- Progress Report Form -->
                <form id="progressReportForm">
                    <input type="hidden" id="progressReportTaskId" name="taskId" />

                    <div class="mb-3">
                        <label for="progressDescription" class="form-label fw-bold">
                            <i class="fa-solid fa-comment me-1"></i>Work Description <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="progressDescription" name="description" rows="4"
                            placeholder="Describe the work completed, materials used, challenges faced, etc."
                            required></textarea>
                        <div class="form-text">Provide detailed information about the work completed in this session.
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="hoursWorked" class="form-label fw-bold">
                                <i class="fa-solid fa-clock me-1"></i>Hours Worked <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="hoursWorked" name="hoursWorked" min="0.1"
                                step="0.1" placeholder="0.0" required>
                            <div class="form-text">Enter the number of hours worked on this task.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="progressPercentage" class="form-label fw-bold">
                                <i class="fa-solid fa-percentage me-1"></i>Progress Percentage
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="progressPercentage"
                                    name="progressPercentage" min="0" max="100" step="1" placeholder="0">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Optional: Estimated completion percentage for this task.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="progressDocuments" class="form-label fw-bold">
                            <i class="fa-solid fa-paperclip me-1"></i>Supporting Documents
                        </label>
                        <input type="file" class="form-control" id="progressDocuments" name="documents" multiple
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.dwg">
                        <div class="form-text">
                            Upload photos, documents, or other files that support your progress report.
                            Supported formats: PDF, DOC, DOCX, JPG, PNG, DWG
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="additionalNotes" class="form-label fw-bold">
                            <i class="fa-solid fa-sticky-note me-1"></i>Additional Notes
                        </label>
                        <textarea class="form-control" id="additionalNotes" name="additionalNotes" rows="2"
                            placeholder="Any additional information, concerns, or requests for the project manager..."></textarea>
                        <div class="form-text">Optional: Any additional information you'd like to share.</div>
                    </div>

                    <!-- Document Preview -->
                    <div id="documentPreview" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Selected Documents</label>
                        <div id="documentList" class="list-group"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="submitProgressReportBtn"
                    onclick="submitProgressReport()">
                    <i class="fa-solid fa-paper-plane me-1"></i>Submit Progress Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function openProgressReportModal(taskId) {
        const modal = new bootstrap.Modal(document.getElementById('progressReportModal'));
        modal.show();

        // Set task ID
        document.getElementById('progressReportTaskId').value = taskId;

        // Load task details
        loadTaskDetailsForProgressModal(taskId);

        // Reset form
        document.getElementById('progressReportForm').reset();
        document.getElementById('documentPreview').style.display = 'none';
        document.getElementById('documentList').innerHTML = '';
    }

    function loadTaskDetailsForProgressModal(taskId) {
        fetch(`/Contractor/GetTaskDetails?taskId=${encodeURIComponent(taskId)}`)
            .then(response => response.json())
            .then(task => {
                if (task) {
                    document.getElementById('modalTaskName').textContent = task.name;
                    document.getElementById('modalProjectName').textContent = task.projectName;
                    document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
                }
            })
            .catch(error => {
                console.error('Failed to load task details:', error);
            });
    }

    function submitProgressReport() {
        const form = document.getElementById('progressReportForm');
        const formData = new FormData(form);

        // Validate required fields
        const description = document.getElementById('progressDescription').value.trim();
        const hoursWorked = parseFloat(document.getElementById('hoursWorked').value);

        if (!description) {
            showToast('Please provide a work description', 'error');
            return;
        }

        if (!hoursWorked || hoursWorked <= 0) {
            showToast('Please enter valid hours worked', 'error');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitProgressReportBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Submitting...';
        submitBtn.disabled = true;

        // Prepare progress report data
        const progressReport = {
            taskId: formData.get('taskId'),
            description: description,
            hoursWorked: hoursWorked,
            status: 'Submitted',
            attachedDocumentIds: [] // Will be populated after document upload
        };

        // Submit progress report
        fetch('/Contractor/SubmitProgressReport', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(progressReport)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Progress report submitted successfully!', 'success');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('progressReportModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // Refresh task card
                    refreshTaskCard(progressReport.taskId);
                } else {
                    showToast('Failed to submit progress report: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting progress report:', error);
                showToast('An error occurred while submitting the progress report', 'error');
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    }

    function refreshTaskCard(taskId) {
        // Reload the task card to show updated information
        const taskCard = document.getElementById(`task-${taskId}`);
        if (taskCard) {
            // Trigger a page refresh or reload the task data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }

    // Document preview functionality
    document.getElementById('progressDocuments').addEventListener('change', function (e) {
        const files = Array.from(e.target.files);
        const preview = document.getElementById('documentPreview');
        const list = document.getElementById('documentList');

        if (files.length > 0) {
            preview.style.display = 'block';
            list.innerHTML = '';

            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <i class="fa-solid fa-file me-2"></i>
                        <span>${file.name}</span>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument(${index})">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        } else {
            preview.style.display = 'none';
        }
    });

    function removeDocument(index) {
        const input = document.getElementById('progressDocuments');
        const dt = new DataTransfer();
        const files = Array.from(input.files);

        files.forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });

        input.files = dt.files;
        input.dispatchEvent(new Event('change'));
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    }
</script>
