@model ICCMS_Web.Models.ProjectDetailDto

@{
    ViewData["Title"] = $"Project: {Model.Name}";
    Layout = "_Layout";
}

<div class="contractor-dashboard-container">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Dashboard", "Contractor")" class="text-decoration-none">
                    <i class="fa-solid fa-home"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fa-solid fa-project-diagram"></i> @Model.Name
            </li>
        </ol>
    </nav>

    <!-- Project Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fa-solid fa-project-diagram me-2" style="color: #F7EC59;"></i>@Model.Name
        </h1>
        <div class="project-status-section">
            <div class="status-badge status-@Model.Status.Replace(" ", "-").ToLower()">
                @Model.Status
            </div>
            <div class="progress-info">
                <span class="progress-percentage">@($"{Model.OverallProgress}%")</span>
                <div class="progress-bar" role="progressbar" aria-valuenow="@Model.OverallProgress" aria-valuemin="0"
                    aria-valuemax="100">
                    <div class="progress-fill" style="width: @($"{Model.OverallProgress}%")"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Summary Cards -->
    <div class="stats-container">
        <div class="row g-2 mb-3">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.TotalTasks</h4>
                        <p class="stat-label">Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon pending">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.PendingTasks</h4>
                        <p class="stat-label">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon in-progress">
                        <i class="fa-solid fa-play"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.InProgressTasks</h4>
                        <p class="stat-label">In Progress</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon completed">
                        <i class="fa-solid fa-circle-check"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.CompletedTasks</h4>
                        <p class="stat-label">Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card compact">
                    <div class="stat-icon overdue">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div class="stat-content">
                        <h4 class="stat-number">@Model.OverdueTasks</h4>
                        <p class="stat-label">Overdue</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Information Grid -->
    <div class="project-info-grid">
        <!-- Project Details -->
        <div class="stat-card">
            <h3><i class="fa-solid fa-info-circle"></i> Project Details</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Project ID:</span>
                    <span class="info-value">@Model.ProjectId</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Client:</span>
                    <span class="info-value">@Model.ClientName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Project Manager:</span>
                    <span class="info-value">@Model.ProjectManagerName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Start Date:</span>
                    <span class="info-value">@Model.StartDate.ToString("dd MMM yyyy")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Planned End:</span>
                    <span class="info-value">@Model.EndDatePlanned.ToString("dd MMM yyyy")</span>
                </div>
                @if (Model.EndDateActual.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Actual End:</span>
                        <span class="info-value">@Model.EndDateActual.Value.ToString("dd MMM yyyy")</span>
                    </div>
                }
            </div>
        </div>

        <!-- Budget Information -->
        <div class="stat-card">
            <h3><i class="fa-solid fa-dollar-sign"></i> Budget Information</h3>
            <div class="budget-grid">
                <div class="budget-item">
                    <span class="budget-label">Planned Budget:</span>
                    <span class="budget-value planned">@Model.BudgetPlanned.ToString("C")</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Actual Budget:</span>
                    <span class="budget-value actual">@Model.BudgetActual.ToString("C")</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Variance:</span>
                    <span class="budget-value variance @(Model.BudgetActual > Model.BudgetPlanned ? "over" : "under")">
                        @((Model.BudgetActual - Model.BudgetPlanned).ToString("C"))
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Section -->
    <div class="main-projects-section">
        <div class="section-header-content">
            <h3 class="section-title">
                <i class="fa-solid fa-tasks me-2"></i>Assigned Tasks
                <span class="badge bg-secondary">@Model.Tasks.Count</span>
            </h3>
            <div class="section-actions">
                <div class="sort-controls">
                    <label for="statusFilter" class="sort-label">Status</label>
                    <select id="statusFilter" class="dashboard-select">
                        <option value="">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="sort-controls">
                    <label for="priorityFilter" class="sort-label">Priority</label>
                    <select id="priorityFilter" class="dashboard-select">
                        <option value="">All Priority</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <button class="dashboard-btn" id="refreshTasksBtn">
                    <i class="fa-solid fa-arrows-rotate"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <div class="tasks-grid" id="tasksList">
        @foreach (var task in Model.Tasks)
        {
            <div class="task-card @(task.IsOverdue ? "overdue" : "")" data-status="@task.Status"
                data-priority="@task.Priority">
                <div class="task-card-header">
                    <div class="task-card-left">
                        <h4 class="task-card-name">@task.Name</h4>
                        <span class="task-card-status @task.Status.Replace(" ", "-").ToLower()">@task.Status</span>
                        <p class="task-card-dates">
                            @task.StartDate.ToString("dd/MM/yyyy") - @task.DueDate.ToString("dd/MM/yyyy")
                        </p>
                    </div>
                    <div class="task-card-right">
                        <span class="task-card-priority priority-@task.Priority.ToLower()">@task.Priority</span>
                        @if (task.IsOverdue)
                        {
                            <span class="overdue-badge">OVERDUE</span>
                        }

                    </div>
                </div>
                <div class="task-card-actions">
                    @if (task.Status == "Pending")
                    {
                        <button class="btn btn-xs btn-warning start-task-btn" data-task-id="@task.TaskId">
                            <i class="fa-solid fa-play"></i> Start
                        </button>
                    }
                    <button class="btn btn-xs btn-info view-details-btn" data-bs-toggle="modal"
                        data-bs-target="#taskDetailsModal" data-task-id="@task.TaskId">
                        <i class="fa-solid fa-eye"></i> Details
                    </button>
                    @if (task.CanSubmitProgress && task.Status != "Pending")
                    {
                        <button class="btn btn-xs btn-primary submit-progress-btn" data-bs-toggle="modal"
                            data-bs-target="#progressReportModal" data-task-id="@task.TaskId">
                            <i class="fa-solid fa-upload"></i> Progress
                        </button>
                    }
                    @if (task.CanRequestCompletion && task.Status != "Pending")
                    {

                        <button class="btn btn-xs btn-success request-completion-btn" data-bs-toggle="modal"
                            data-bs-target="#completionRequestModal" data-task-id="@task.TaskId">
                            <i class="fa-solid fa-check"></i> Complete
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Include modals -->
@await Html.PartialAsync("_TaskDetailsModal")
@await Html.PartialAsync("_ProgressReportModal")
@await Html.PartialAsync("_CompletionRequestModal")

<!-- Include dashboard CSS -->
<link rel="stylesheet" href="~/css/contractor-dashboard.css" />
<link rel="stylesheet" href="~/css/contractor-task-cards.css" />

<!-- Include JavaScript -->
<script src="~/js/contractor-universal-modal.js"></script>
<script src="~/js/contractor-project-detail.js"></script>
