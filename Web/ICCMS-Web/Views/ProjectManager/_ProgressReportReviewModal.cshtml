<!-- Progress Report Review Modal -->
<div class="modal fade" id="progressReportReviewModal" tabindex="-1" aria-labelledby="progressReportReviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressReportReviewModalLabel">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Review Progress Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="progressReportContent">
                    <!-- Progress report details will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading progress report...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger me-2" id="rejectProgressBtn">
                    <i class="fa-solid fa-times me-1"></i>Reject
                </button>
                <button type="button" class="btn btn-success" id="approveProgressBtn">
                    <i class="fa-solid fa-check me-1"></i>Approve
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Notes Modal -->
<div class="modal fade" id="rejectionNotesModal" tabindex="-1" aria-labelledby="rejectionNotesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectionNotesModalLabel">
                    <i class="fa-solid fa-times-circle me-2"></i>Reject Progress Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionNotes" class="form-label">Rejection Notes</label>
                    <textarea class="form-control" id="rejectionNotes" rows="4"
                        placeholder="Please provide feedback on why this progress report is being rejected..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i class="fa-solid fa-times me-1"></i>Reject Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const progressReportModal = document.getElementById('progressReportReviewModal');
        const rejectionNotesModal = document.getElementById('rejectionNotesModal');
        const progressReportContent = document.getElementById('progressReportContent');
        const approveProgressBtn = document.getElementById('approveProgressBtn');
        const rejectProgressBtn = document.getElementById('rejectProgressBtn');
        const confirmRejectBtn = document.getElementById('confirmRejectBtn');
        const rejectionNotes = document.getElementById('rejectionNotes');

        let currentReportId = null;

        // Handle approve button
        approveProgressBtn.addEventListener('click', function () {
            if (!currentReportId) return;

            if (!confirm('Are you sure you want to approve this progress report?')) {
                return;
            }

            approveProgressBtn.disabled = true;
            approveProgressBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Approving...';

            fetch(`/ProjectManager/ApproveProgressReport?reportId=${currentReportId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('Progress report approved successfully!');
                        progressReportModal.hide();
                        // Refresh approvals list
                        if (typeof refreshApprovalsList === 'function') {
                            refreshApprovalsList();
                        }
                    } else {
                        showErrorMessage(data.error || 'Failed to approve progress report');
                    }
                })
                .catch(error => {
                    console.error('Error approving progress report:', error);
                    showErrorMessage('An error occurred while approving the progress report');
                })
                .finally(() => {
                    approveProgressBtn.disabled = false;
                    approveProgressBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Approve';
                });
        });

        // Handle reject button
        rejectProgressBtn.addEventListener('click', function () {
            rejectionNotesModal.show();
        });

        // Handle confirm reject
        confirmRejectBtn.addEventListener('click', function () {
            if (!currentReportId) return;

            const notes = rejectionNotes.value.trim();

            confirmRejectBtn.disabled = true;
            confirmRejectBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Rejecting...';

            fetch(`/ProjectManager/RejectProgressReport?reportId=${currentReportId}&notes=${encodeURIComponent(notes)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('Progress report rejected');
                        rejectionNotesModal.hide();
                        progressReportModal.hide();
                        // Refresh approvals list
                        if (typeof refreshApprovalsList === 'function') {
                            refreshApprovalsList();
                        }
                    } else {
                        showErrorMessage(data.error || 'Failed to reject progress report');
                    }
                })
                .catch(error => {
                    console.error('Error rejecting progress report:', error);
                    showErrorMessage('An error occurred while rejecting the progress report');
                })
                .finally(() => {
                    confirmRejectBtn.disabled = false;
                    confirmRejectBtn.innerHTML = '<i class="fa-solid fa-times me-1"></i>Reject Report';
                });
        });

        // Reset rejection notes when modal is shown
        rejectionNotesModal.addEventListener('show.bs.modal', function () {
            rejectionNotes.value = '';
        });

        // Global function to show progress report (called from approval actions)
        window.showProgressReport = function (reportId) {
            currentReportId = reportId;
            loadProgressReportDetails(reportId);
            progressReportModal.show();
        };

        function loadProgressReportDetails(reportId) {
            // Show loading state
            progressReportContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading progress report...</p>
            </div>
        `;

            // Fetch the actual progress report details
            fetch(`/ProjectManager/GetProgressReport?reportId=${reportId}`)
                .then(response => response.json())
                .then(async (data) => {
                    if (data.success && data.data) {
                        const report = data.data;
                        
                        // Load photos from attached documents
                        let photosHtml = '';
                        if (report.attachedDocumentIds && report.attachedDocumentIds.length > 0) {
                            const photos = await loadPhotosFromDocuments(report.attachedDocumentIds);
                            if (photos.length > 0) {
                                photosHtml = photos.map((photo, index) => {
                                    const safeUrl = photo.url.replace(/'/g, "\\'");
                                    const safeFileName = (photo.fileName || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                                    return `
                                    <div class="col-md-4 col-sm-6">
                                        <div class="photo-thumbnail-container" style="position: relative; cursor: pointer;" data-photo-url="${safeUrl}" data-photo-name="${safeFileName}">
                                            <img src="${safeUrl}" alt="${safeFileName}" class="img-fluid rounded shadow-sm" style="width: 100%; height: 200px; object-fit: cover;" />
                                            <div class="photo-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; border-radius: 0.25rem;">
                                                <i class="fa-solid fa-expand text-white fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }).join('');
                            }
                        }
                        
                        progressReportContent.innerHTML = `
                        <div class="progress-report-details">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>Report Information</h6>
                                    <p><strong>Report ID:</strong> ${report.progressReportId || reportId}</p>
                                    <p><strong>Submitted:</strong> ${new Date(report.submittedAt || report.createdAt).toLocaleString()}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-warning">Pending Review</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Contractor Information</h6>
                                    <p><strong>Submitted By:</strong> ${report.submittedBy || 'Unknown'}</p>
                                    <p><strong>Hours Worked:</strong> ${report.hoursWorked || 0}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Description</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <p>${report.description || 'No description provided'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Progress Details</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <p><strong>Progress Percentage:</strong> ${report.progressPercentage || 0}%</p>
                                        <p><strong>Work Completed:</strong> ${report.workCompleted || 'Not specified'}</p>
                                        <p><strong>Challenges:</strong> ${report.challenges || 'None reported'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Attachments</h6>
                                <div id="reportAttachments">
                                    ${report.attachments && report.attachments.length > 0 
                                        ? report.attachments.map(att => 
                                            `<div class="mb-2">
                                                <a href="${att.url}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fa-solid fa-download me-1"></i>${att.fileName || 'Download'}
                                                </a>
                                            </div>`
                                          ).join('')
                                        : '<p class="text-muted">No attachments</p>'
                                    }
                                </div>
                            </div>
                            
                            ${photosHtml ? `
                            <div class="mb-3">
                                <h6><i class="fa-solid fa-camera me-2"></i>Photos</h6>
                                <div class="row g-2">
                                    ${photosHtml}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        `;
                        
                        // Add photo overlay hover effect and click handler
                        document.querySelectorAll('.photo-thumbnail-container').forEach(container => {
                            container.addEventListener('mouseenter', function() {
                                this.querySelector('.photo-overlay').style.opacity = '1';
                            });
                            container.addEventListener('mouseleave', function() {
                                this.querySelector('.photo-overlay').style.opacity = '0';
                            });
                            container.addEventListener('click', function() {
                                const url = this.getAttribute('data-photo-url');
                                const fileName = this.getAttribute('data-photo-name');
                                showPhotoModal(url, fileName);
                            });
                        });
                    } else {
                        progressReportContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            Failed to load progress report details. Please try again.
                        </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading progress report:', error);
                    progressReportContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fa-solid fa-exclamation-circle me-2"></i>
                        Error loading progress report. Please check your connection and try again.
                    </div>
                    `;
                });
        }
    });

    function showSuccessMessage(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-success position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-check-circle me-2"></i>
            <span>${message}</span>
        </div>
    `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function showErrorMessage(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-danger position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-exclamation-circle me-2"></i>
            <span>${message}</span>
        </div>
    `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }
    
    // Function to load photos from document IDs
    async function loadPhotosFromDocuments(documentIds) {
        const photos = [];
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
        
        for (const docId of documentIds) {
            try {
                const response = await fetch(`/api/documents/metadata?projectId=`);
                const allDocs = await response.json();
                const doc = Array.isArray(allDocs) ? allDocs.find(d => d.documentId === docId) : null;
                
                if (doc && doc.fileUrl) {
                    const fileExt = doc.fileName ? doc.fileName.toLowerCase().substring(doc.fileName.lastIndexOf('.')) : '';
                    if (imageExtensions.includes(fileExt)) {
                        photos.push({
                            url: doc.fileUrl,
                            fileName: doc.fileName || docId,
                            documentId: docId
                        });
                    }
                }
            } catch (error) {
                console.error(`Error loading document ${docId}:`, error);
            }
        }
        
        return photos;
    }
    
    // Photo viewer modal
    function showPhotoModal(imageUrl, fileName) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'photoViewerModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fa-solid fa-image me-2"></i>${fileName || 'Photo'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center p-0">
                        <img src="${imageUrl}" alt="${fileName}" class="img-fluid" style="max-height: 80vh; width: auto;" />
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
</script>
