@model ICCMS_Web.Models.TaskDetailViewModel

@{
    ViewData["Title"] = $"Task: {Model.Task.Name}";
    Layout = "_Layout";
}

<div class="pm-project-detail-container">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Dashboard", "ProjectManager")" class="text-decoration-none">
                    <i class="fa-solid fa-home"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action("ProjectDetail", "ProjectManager", new { projectId = Model.Project.ProjectId })" class="text-decoration-none">
                    <i class="fa-solid fa-project-diagram"></i> @Model.Project.Name
                </a>
            </li>
            @if (Model.Phase != null)
            {
                <li class="breadcrumb-item">
                    <a href="@Url.Action("PhaseDetail", "ProjectManager", new { projectId = Model.Project.ProjectId, phaseId = Model.Phase.PhaseId })" class="text-decoration-none">
                        <i class="fa-solid fa-layer-group"></i> @Model.Phase.Name
                    </a>
                </li>
            }
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fa-solid fa-tasks"></i> @Model.Task.Name
            </li>
        </ol>
    </nav>

    <!-- Task Information Header -->
    <div class="row mb-4 pm-project-header">
        <div class="col-md-8">
            <h4 class="mb-2">@Model.Task.Name</h4>
            <p class="mb-1">Task ID: <span>@Model.Task.TaskId</span></p>
            <p class="mb-0">Description: <span>@Model.Task.Description</span></p>
        </div>
        <div class="col-md-4 text-end">
            <div class="mb-2">
                <span class="badge @Model.GetStatusBadgeClass(Model.Task.Status) me-2">@Model.Task.Status</span>
                <span class="badge @Model.GetPriorityBadgeClass(Model.Task.Priority) me-2">@Model.Task.Priority</span>
                <span class="badge pm-badge-secondary">@Model.Task.Progress% Complete</span>
            </div>
            <small>
                <i class="fa-solid fa-calendar me-1"></i>
                <span>@Model.Task.StartDate.ToString("dd MMM yyyy")</span> -
                <span>@Model.Task.DueDate.ToString("dd MMM yyyy")</span>
            </small>
        </div>
    </div>

    <!-- Progress Section (Compressed) -->
    <div class="row mb-4 pm-progress-section">
        <div class="col-md-3">
            <h6 class="mb-2">Task Progress</h6>
            <div class="progress mb-2 pm-progress">
                <div class="progress-bar pm-progress-bar" role="progressbar"
                    style="width: @($"{Model.Task.Progress}%")" aria-valuenow="@Model.Task.Progress"
                    aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small>@($"{Model.Task.Progress}%") Complete</small>
        </div>
        <div class="col-md-3">
            <h6 class="mb-2">Estimated Hours</h6>
            <div class="fw-bold">@Model.Task.EstimatedHours hours</div>
        </div>
        <div class="col-md-3">
            <h6 class="mb-2">Actual Hours</h6>
            <div class="fw-bold">@Model.Task.ActualHours hours</div>
        </div>
        <div class="col-md-3">
            <h6 class="mb-2">Budget</h6>
            <div class="fw-bold">R @Model.Task.Budget.ToString("N0")</div>
        </div>
    </div>

    <!-- Progress Reports & Completion Reports - MAIN FOCUS -->
    <div class="row mb-4">
        <!-- Progress Reports -->
        <div class="col-md-6 mb-4">
            <div class="pm-reports-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-chart-line me-2 text-info"></i>Progress Reports
                        <span class="badge pm-badge-secondary">@Model.ProgressReports.Count</span>
                    </h5>
                </div>

                @if (Model.ProgressReports.Any())
                {
                    <div class="card pm-reports-card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>By</th>
                                            <th>Hours</th>
                                            <th>Progress</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var report in Model.ProgressReports)
                                        {
                                            <tr>
                                                <td>@report.SubmittedAt.ToString("dd MMM yy")</td>
                                                <td>@Model.GetContractorName(report.SubmittedBy)</td>
                                                <td>@report.HoursWorked.ToString("F1")h</td>
                                                <td>
                                                    @if (report.ProgressPercentage.HasValue)
                                                    {
                                                        <span class="badge pm-badge-secondary">@report.ProgressPercentage.Value%</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge @Model.GetProgressReportStatusBadgeClass(report.Status)">@report.Status</span>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm pm-btn-outline-info view-progress-report-btn" 
                                                            data-report-id="@report.ProgressReportId">
                                                        <i class="fa-solid fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card pm-reports-card">
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="fa-regular fa-chart-line"></i>
                                <p>No progress reports</p>
                                <small>Progress updates will appear here</small>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Completion Reports -->
        <div class="col-md-6 mb-4">
            <div class="pm-reports-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-clipboard-check me-2 text-warning"></i>Completion Reports
                        <span class="badge pm-badge-secondary">@Model.CompletionReports.Count</span>
                    </h5>
                </div>

                @if (Model.CompletionReports.Any())
                {
                    <div class="card pm-reports-card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>By</th>
                                            <th>Completed</th>
                                            <th>Hours</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var report in Model.CompletionReports)
                                        {
                                            <tr>
                                                <td>@report.SubmittedAt.ToString("dd MMM yy")</td>
                                                <td>@Model.GetContractorName(report.SubmittedBy)</td>
                                                <td>@report.CompletionDate.ToString("dd MMM yy")</td>
                                                <td>@report.FinalHours.ToString("F1")h</td>
                                                <td>
                                                    <span class="badge @Model.GetCompletionReportStatusBadgeClass(report.Status)">@report.Status</span>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm pm-btn-outline-info view-completion-report-btn" 
                                                            data-report-id="@report.CompletionReportId">
                                                        <i class="fa-solid fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card pm-reports-card">
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="fa-regular fa-clipboard-check"></i>
                                <p>No completion reports</p>
                                <small>Completion reports will appear here</small>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Task Information Cards -->
    <div class="row mb-4 pm-middle-section">
        <div class="col-md-6 mb-4">
            <div class="pm-budget-section mb-4">
                <h6 class="mb-2">Budget Information</h6>
                <div class="card pm-budget-card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <small>Task Budget</small>
                                <div class="fw-bold">R @Model.Task.Budget.ToString("N0")</div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small>Spent Amount</small>
                                <div class="fw-bold">R @Model.Task.SpentAmount.ToString("N0")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pm-stats-section">
                <h6 class="mb-2">Assignment</h6>
                <div class="card pm-stats-card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <small>Assigned To</small>
                                <div class="fw-bold">
                                    @if (Model.Contractor != null)
                                    {
                                        @Model.Contractor.FullName
                                    }
                                    else
                                    {
                                        <span class="text-muted">Unassigned</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card pm-stats-card">
                <div class="card-body">
                    <h6 class="mb-3">Timeline Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small>Start Date</small>
                            <div class="fw-bold">@Model.Task.StartDate.ToString("dd MMM yyyy")</div>
                        </div>
                        <div class="col-md-6">
                            <small>Due Date</small>
                            <div class="fw-bold @(Model.IsOverdue() ? "text-danger" : "")">@Model.Task.DueDate.ToString("dd MMM yyyy")</div>
                        </div>
                    </div>
                    @if (Model.Task.CompletedDate.HasValue)
                    {
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <small>Completed Date</small>
                                <div class="fw-bold">@Model.Task.CompletedDate.Value.ToString("dd MMM yyyy")</div>
                            </div>
                        </div>
                    }
                    @if (Model.Phase != null)
                    {
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <small>Phase</small>
                                <div class="fw-bold">
                                    <a href="@Url.Action("PhaseDetail", "ProjectManager", new { projectId = Model.Project.ProjectId, phaseId = Model.Phase.PhaseId })" 
                                       class="text-decoration-none">
                                        @Model.Phase.Name
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    <div class="mb-4 pm-tasks-section">
        <h6 class="mb-3">
            <i class="fa-solid fa-info-circle me-2"></i>Additional Information
        </h6>
        <div class="card pm-stats-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <small>Task ID</small>
                        <div class="fw-bold font-monospace" style="font-size: 0.9rem;">@Model.Task.TaskId</div>
                    </div>
                    <div class="col-md-3">
                        <small>Status</small>
                        <div class="fw-bold">@Model.Task.Status</div>
                    </div>
                    <div class="col-md-3">
                        <small>Priority</small>
                        <div class="fw-bold">@Model.Task.Priority</div>
                    </div>
                    <div class="col-md-3">
                        <small>Progress</small>
                        <div class="fw-bold">@Model.Task.Progress%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Progress Report Detail Modal -->
<div class="modal fade" id="progressReportModal" tabindex="-1" aria-labelledby="progressReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressReportModalLabel">
                    <i class="fa-solid fa-chart-line me-2"></i>Progress Report Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="progressReportModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading progress report...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Report Detail Modal -->
<div class="modal fade" id="completionReportModal" tabindex="-1" aria-labelledby="completionReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completionReportModalLabel">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Completion Report Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="completionReportModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading completion report...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Include CSS -->
<link rel="stylesheet" href="~/css/pm-project-detail.css" />
<link rel="stylesheet" href="~/css/modal-design-system.css" />

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle View Progress Report button clicks
        document.querySelectorAll('.view-progress-report-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const reportId = this.getAttribute('data-report-id');
                if (!reportId) return;

                const modal = new bootstrap.Modal(document.getElementById('progressReportModal'));
                const modalBody = document.getElementById('progressReportModalBody');
                
                // Show loading state
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading progress report...</p>
                    </div>
                `;
                modal.show();

                try {
                    const response = await fetch(`/ProjectManager/GetProgressReport?reportId=${encodeURIComponent(reportId)}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch progress report');
                    }
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to load progress report');
                    }
                    const report = data.report;

                    // Render progress report details
                    const submittedDate = report.submittedAt ? new Date(report.submittedAt).toLocaleString() : 'N/A';
                    const reviewedDate = report.reviewedAt ? new Date(report.reviewedAt).toLocaleString() : null;
                    
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Submitted Date</small>
                                <div class="fw-bold">${submittedDate}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Submitted By</small>
                                <div class="fw-bold">${report.submittedBy || 'Unknown'}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Hours Worked</small>
                                <div class="fw-bold">${report.hoursWorked || 0} hours</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Progress Percentage</small>
                                <div class="fw-bold">${report.progressPercentage !== null && report.progressPercentage !== undefined ? report.progressPercentage + '%' : 'N/A'}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Status</small>
                                <div><span class="badge ${getProgressReportStatusBadge(report.status)}">${report.status || 'Unknown'}</span></div>
                            </div>
                            ${report.reviewedBy ? `
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Reviewed By</small>
                                <div class="fw-bold">${report.reviewedBy}</div>
                            </div>
                            ` : ''}
                            ${reviewedDate ? `
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Reviewed At</small>
                                <div class="fw-bold">${reviewedDate}</div>
                            </div>
                            ` : ''}
                            <div class="col-12 mb-3">
                                <small class="text-muted">Description</small>
                                <div class="fw-bold">${report.description || 'No description provided'}</div>
                            </div>
                            ${report.reviewNotes ? `
                            <div class="col-12 mb-3">
                                <small class="text-muted">Review Notes</small>
                                <div class="fw-bold">${report.reviewNotes}</div>
                            </div>
                            ` : ''}
                            ${report.attachedDocumentIds && report.attachedDocumentIds.length > 0 ? `
                            <div class="col-12 mb-3">
                                <small class="text-muted">Attached Documents</small>
                                <div>
                                    ${report.attachedDocumentIds.map(docId => `
                                        <span class="badge bg-info me-1">Document: ${docId.substring(0, 8)}...</span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading progress report:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fa-solid fa-exclamation-circle me-2"></i>
                            Failed to load progress report. Please try again later.
                        </div>
                    `;
                }
            });
        });

        function getProgressReportStatusBadge(status) {
            switch (status?.toLowerCase()) {
                case 'submitted': return 'badge-info';
                case 'approved': return 'badge-success';
                case 'rejected': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        function getCompletionReportStatusBadge(status) {
            switch (status?.toLowerCase()) {
                case 'submitted': return 'badge-warning';
                case 'approved': return 'badge-success';
                case 'rejected': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        // Handle View Completion Report button clicks
        document.querySelectorAll('.view-completion-report-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const reportId = this.getAttribute('data-report-id');
                if (!reportId) return;

                const modal = new bootstrap.Modal(document.getElementById('completionReportModal'));
                const modalBody = document.getElementById('completionReportModalBody');
                
                // Show loading state
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading completion report...</p>
                    </div>
                `;
                modal.show();

                try {
                    const response = await fetch(`/ProjectManager/GetCompletionReport?id=${encodeURIComponent(reportId)}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch completion report');
                    }
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to load completion report');
                    }
                    const report = data.data || data.report;

                    // Render completion report details
                    const submittedDate = report.submittedAt ? new Date(report.submittedAt).toLocaleString() : 'N/A';
                    const completionDate = report.completionDate ? new Date(report.completionDate).toLocaleString() : 'N/A';
                    const reviewedDate = report.reviewedAt ? new Date(report.reviewedAt).toLocaleString() : null;
                    
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Submitted Date</small>
                                <div class="fw-bold">${submittedDate}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Submitted By</small>
                                <div class="fw-bold">${report.submittedBy || 'Unknown'}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Completion Date</small>
                                <div class="fw-bold">${completionDate}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Final Hours</small>
                                <div class="fw-bold">${report.finalHours || 0} hours</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Spent Amount</small>
                                <div class="fw-bold">R ${(report.spentAmount || 0).toLocaleString('en-ZA', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Status</small>
                                <div><span class="badge ${getCompletionReportStatusBadge(report.status)}">${report.status || 'Unknown'}</span></div>
                            </div>
                            ${report.reviewedBy ? `
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Reviewed By</small>
                                <div class="fw-bold">${report.reviewedBy}</div>
                            </div>
                            ` : ''}
                            ${reviewedDate ? `
                            <div class="col-md-6 mb-3">
                                <small class="text-muted">Reviewed At</small>
                                <div class="fw-bold">${reviewedDate}</div>
                            </div>
                            ` : ''}
                            <div class="col-12 mb-3">
                                <small class="text-muted">Completion Summary</small>
                                <div class="fw-bold">${report.completionSummary || 'No summary provided'}</div>
                            </div>
                            ${report.qualityCheck ? `
                            <div class="col-12 mb-3">
                                <small class="text-muted">Quality Check</small>
                                <div class="fw-bold">${report.qualityCheck}</div>
                            </div>
                            ` : ''}
                            ${report.reviewNotes ? `
                            <div class="col-12 mb-3">
                                <small class="text-muted">Review Notes</small>
                                <div class="fw-bold">${report.reviewNotes}</div>
                            </div>
                            ` : ''}
                            ${report.attachedDocumentIds && report.attachedDocumentIds.length > 0 ? `
                            <div class="col-12 mb-3">
                                <small class="text-muted">Attached Documents</small>
                                <div>
                                    ${report.attachedDocumentIds.map(docId => `
                                        <span class="badge bg-info me-1">Document: ${docId.substring(0, 8)}...</span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading completion report:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fa-solid fa-exclamation-circle me-2"></i>
                            Failed to load completion report. Please try again later.
                        </div>
                    `;
                }
            });
        });
    });
</script>

<!-- Include CSS -->
<link rel="stylesheet" href="~/css/pm-project-detail.css" />
<link rel="stylesheet" href="~/css/modal-design-system.css" />

