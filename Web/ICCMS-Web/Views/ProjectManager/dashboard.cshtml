@model ICCMS_Web.Models.DashboardViewModel
@{
    ViewData["Title"] = "Project Manager Dashboard";
    Layout = "_Layout";
}

@await Html.PartialAsync("_QuoteBuilder")

<div class="container mt-4">
    <h2 class="fw-bold mb-2">üß± Project Manager Dashboard</h2>
    <p class="text-muted mb-4">Manage projects, build quotations, and track client responses.</p>

    <a href="@Url.Action("CreateProject", "ProjectManager")" class="btn btn-dark mb-4">
        <i class="fas fa-plus-circle me-1"></i> New Project
    </a>

    @if (Model.RecentProjects?.Any() == true)
    {
        <div class="d-flex flex-column gap-3">
            @foreach (var project in Model.RecentProjects)
            {
                var client = Model.Clients.FirstOrDefault(c => c.UserId == project.ClientId);
                var clientName = client?.FullName ?? "Unknown Client";

                var projectQuotes = Model.AllQuotes
                    .Where(q => q.ProjectId == project.ProjectId)
                    .OrderByDescending(q => q.CreatedAt)
                    .ToList();

                var quoteCount = projectQuotes.Count;
                var latestQuote = projectQuotes.FirstOrDefault();
                var latestStatus = latestQuote?.Status ?? "None";
                var latestQuoteId = latestQuote?.QuotationId ?? string.Empty;

                <div class="p-3 rounded shadow-sm bg-white border-start border-4 border-primary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold mb-0">@project.Name</h5>
                        <span class="badge bg-secondary">@project.Status</span>
                    </div>

                    <p class="text-muted small mb-2">
                        Client: <strong>@clientName</strong> &nbsp; ‚Ä¢ &nbsp;
                        Start: @project.StartDate.ToString("yyyy-MM-dd") &nbsp; ‚Ä¢ &nbsp;
                        End: @project.EndDatePlanned.ToString("yyyy-MM-dd") &nbsp; ‚Ä¢ &nbsp;
                        Budget: R @project.BudgetPlanned.ToString("N0")
                    </p>

                    <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
                        <span class="badge bg-info text-dark">
                            Quotes: @quoteCount
                        </span>

                        @if (quoteCount > 0)
                        {
                            var firstQuote = projectQuotes.First();

                            if (!string.IsNullOrEmpty(firstQuote.QuotationId))
                            {
                                <a href="@Url.Action("DownloadQuote", "Quotes", new { id = firstQuote.QuotationId })"
                                   target="_blank"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-file-earmark-pdf me-1"></i> Download Quote
                                </a>
                            }
                            else
                            {
                                <span class="text-muted small">(Quote ID missing)</span>
                            }

                            <!-- Always show dev-only Simulate button -->
                            <button type="button"
                                    class="btn btn-outline-warning btn-sm"
                                    onclick="simulateClientApproval('@(firstQuote.QuotationId ?? project.ProjectId)')">
                                <i class="bi bi-person-check-fill me-1"></i> Simulate Client Approval
                            </button>
                        }
                    </div>

                    <div class="mt-2">
                        @if (latestStatus == "ClientAccepted" || latestStatus == "QuoteAccepted")
                        {
                            <a href="@Url.Action("SetupProject", "ProjectManager", new { id = project.ProjectId })"
                               class="btn btn-success btn-sm fw-bold">
                                <i class="fas fa-diagram-project me-1"></i> Set Up Project
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-warning btn-sm fw-bold"
                                    data-bs-toggle="modal"
                                    data-bs-target="#quoteBuilderModal"
                                    data-project-id="@project.ProjectId"
                                    data-project-name="@project.Name"
                                    data-description="@project.Description"
                                    data-client-id="@project.ClientId"
                                    data-contractor-id="@User.FindFirst("UserId")?.Value">
                                <i class="fas fa-file-invoice-dollar me-1"></i> Build Quote
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">No projects found. Create one to begin.</div>
    }
</div>

@section Scripts {
    <script src="~/js/quote-builder.js"></script>

    <script>
        // Inject project data into Quote Builder modal
        document.getElementById("quoteBuilderModal")
            .addEventListener("show.bs.modal", function (event) {
                const btn = event.relatedTarget;
                if (!btn) return;
                document.getElementById("qb-projectId").value = btn.dataset.projectId || "";
                document.getElementById("qb-clientId").value = btn.dataset.clientId || "";
                document.getElementById("qb-contractorId").value = btn.dataset.contractorId || "";
                console.log("üü¢ Opening Quote Builder for:", btn.dataset.projectName);
            });

        // DEV-ONLY: simulate client approval
        async function simulateClientApproval(quoteId) {
        if (!quoteId) return alert("No quote ID found.");
        if (!confirm("Simulate client approval for this quote?")) return;

        try {
            const res = await fetch(`/Quotes/simulate-client-approval/${quoteId}`, { method: "POST" });
            if (!res.ok) throw new Error(`API error ${res.status}`);
            showToast("‚úÖ Simulated client approval successfully!");
            setTimeout(() => window.location.reload(), 1000);
        } catch (err) {
            console.error("üî• Simulate approval failed:", err);
            showToast("‚ùå Failed to simulate approval.");
        }
        }

    </script>
}

<style>
    /* === Dashboard Styling Improvements === */
    body {
        background-color: #f9fafc;
    }

    .card, .shadow-sm {
        transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .shadow-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .badge {
        font-size: 0.8rem;
    }

    .btn-sm {
        font-size: 0.82rem;
    }
</style>

