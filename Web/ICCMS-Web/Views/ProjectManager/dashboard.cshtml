@model ICCMS_Web.Models.DashboardViewModel
@{
    ViewData["Title"] = "Project Manager Dashboard";
    Layout = "_Layout";
}

@await Html.PartialAsync("_QuoteBuilder")

<div class="container mt-4">
    <h2 class="fw-bold mb-3">ðŸ§± Project Manager Dashboard (Simplified)</h2>
    <p class="text-muted mb-4">Basic view for development and Quote Builder testing.</p>

    <a href="@Url.Action("CreateProject", "ProjectManager")" class="btn btn-dark mb-3">
        <i class="fas fa-plus-circle me-1"></i> New Project
    </a>

    @if (Model.RecentProjects != null && Model.RecentProjects.Any())
    {
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Project Name</th>
                    <th>Status</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Budget (R)</th>
                    <th>Client</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var project in Model.RecentProjects)
                {
                    <tr>
                        <td>@project.Name</td>
                        <td>@project.Status</td>
                        <td>@project.StartDate.ToString("yyyy-MM-dd")</td>
                        <td>@project.EndDatePlanned.ToString("yyyy-MM-dd")</td>
                        <td>@project.BudgetPlanned.ToString("N2")</td>
                        <td>@project.ClientId</td>
                        <td>
                            <button class="btn btn-sm btn-warning fw-bold"
                                    data-bs-toggle="modal"
                                    data-bs-target="#quoteBuilderModal"
                                    data-project-id="@project.ProjectId"
                                    data-project-name="@project.Name"
                                    data-description="@project.Description"
                                    data-client-id="@project.ClientId"
                                    data-contractor-id="@User.FindFirst("UserId")?.Value">
                                <i class="fas fa-file-invoice-dollar me-1"></i> Build Quote
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">
            No projects available yet. Create one to begin testing.
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/quote-builder.js"></script>

    <script>
        // Autofill modal fields when Build Quote button is clicked
        document.getElementById("quoteBuilderModal").addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            if (!button) return;

            document.getElementById("qb-projectId").value = button.dataset.projectId || "";
            document.getElementById("qb-clientId").value = button.dataset.clientId || "";
            document.getElementById("qb-contractorId").value = button.dataset.contractorId || "";

            console.log("ðŸŸ¢ Opening Quote Builder for:", button.dataset.projectName);
        });
    </script>
}
