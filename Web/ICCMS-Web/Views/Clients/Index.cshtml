@model ICCMS_Web.Controllers.ClientDashboardViewModel
@{
    ViewData["Title"] = "Client Dashboard";
    Layout = "_Layout";
}

<div class="pm-dashboard-container">
    <!-- Header -->
    <div class="dashboard-header construction-border">
        <h1 class="dashboard-title">@User.Identity.Name Dashboard</h1>
        <p class="dashboard-subtitle">
            Welcome back, @User.Identity.Name! View your projects, quotations, and maintenance requests.
        </p>
    </div>

    <!-- Search + Filter Controls -->
    <div class="dashboard-controls">
        <div class="search-section">
            <div class="search-input-group">
                <input type="text" id="searchInput" class="search-input" placeholder="Search projects or quotes..." />
                <button type="button" id="searchBtn" class="search-btn">
                    <i class="fa-solid fa-search"></i>
                </button>
                <button type="button" id="clearSearchBtn" class="clear-search-btn" title="Clear search">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Filter Toggle -->
        <div class="filter-section">
            <div class="d-flex justify-content-center mb-3">
                <button type="button" class="filter-toggle-btn" onclick="toggleFilters()">
                    <i class="fa-solid fa-sliders-h me-2"></i>
                    <span id="filterToggleText">Show Filters</span>
                    <i class="fa-solid fa-chevron-down ms-2" id="filterToggleIcon"></i>
                </button>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="filters-panel construction-border-thin" id="filtersPanel" style="display:none;">
            <div class="filters-container">
                <div class="filter-group">
                    <div class="filter-group-header"><h6>Status</h6></div>
                    <div class="status-filters">
                        @{
                            var statuses = new[] { "All", "Active", "Completed", "Pending", "Resolved" };
                        }
                        @foreach (var status in statuses)
                        {
                            <a href="#" class="status-filter-btn" data-status="@status">
                                <i class="fa-solid fa-circle me-2"></i>@status
                            </a>
                        }
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-header"><h6>Date Range</h6></div>
                    <div class="advanced-filters-grid">
                        <div class="filter-item">
                            <label class="filter-label">Start From</label>
                            <input type="date" id="filterStart" class="filter-input" />
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">End To</label>
                            <input type="date" id="filterEnd" class="filter-input" />
                        </div>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="button" class="filter-action-btn primary" onclick="applyClientFilters()">
                        <i class="fa-solid fa-search me-2"></i>Apply
                    </button>
                    <button type="button" class="filter-action-btn secondary" onclick="clearClientFilters()">
                        <i class="fa-solid fa-times me-2"></i>Clear
                    </button>
                    <button type="button" class="filter-action-btn tertiary" onclick="toggleFilters()">
                        <i class="fa-solid fa-chevron-up me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Maintenance Requests ===== -->
    <div class="section-header construction-border-thin mt-4">
        <h3 class="section-title">
            Maintenance Requests
            <span class="badge badge-secondary">@((Model.MaintenanceRequests?.Count ?? 0))</span>
        </h3>
        <button type="button" class="btn btn-sm btn-warning" onclick="showMaintenanceForm()">+ New Request</button>
    </div>

    <div class="projects-grid" id="maintenanceRequestsGrid">
        @if (Model.MaintenanceRequests?.Any() == true)
        {
            foreach (var req in Model.MaintenanceRequests)
            {
                var projectName = Model.Projects.FirstOrDefault(p => p.ProjectId == req.ProjectId)?.Name ?? "Unknown Project";
                ViewBag.ProjectName = projectName;
                @await Html.PartialAsync("_MaintenanceRequestCard", req)
            }
        }
        else
        {
            <div class="no-projects-message text-center py-5">
                <i class="fa-solid fa-screwdriver-wrench fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No maintenance requests yet</h5>
                <p class="text-muted">Submit one using the button above.</p>
            </div>
        }
    </div>

    <!-- ===== Projects Section ===== -->
    <div class="section-header construction-border-thin mt-4">
        <h3 class="section-title">
            My Projects
            <span class="badge badge-secondary">@((Model.Projects?.Count ?? 0))</span>
        </h3>
    </div>

    <div class="projects-grid" id="projectsGrid">
        @if (Model.Projects?.Any() == true)
        {
            foreach (var project in Model.Projects)
            {
                ViewBag.Progress = 0;
                ViewBag.ClientName = User.Identity?.Name ?? "Client";
                @await Html.PartialAsync("_ClientProjectCard", project)
            }
        }
        else
        {
            <div class="no-projects-message text-center py-5">
                <i class="fa-solid fa-folder-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No projects found</h5>
            </div>
        }
    </div>

    <!-- ===== Quotations Section ===== -->
    <div class="section-header construction-border-thin mt-4">
        <h3 class="section-title">
            Quotations
            <span class="badge badge-secondary">@((Model.Quotations?.Count ?? 0))</span>
        </h3>
    </div>

    <div class="projects-grid" id="quotationsGrid">
        @if (Model.Quotations?.Any() == true)
        {
            foreach (var quote in Model.Quotations)
            {
                @await Html.PartialAsync("_QuotationCard", quote)
            }
        }
        else
        {
            <div class="no-projects-message text-center py-5">
                <i class="fa-solid fa-file-invoice fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No quotations found</h5>
            </div>
        }
    </div>
</div>

<link rel="stylesheet" href="~/css/pm-dashboard.css" />
<link rel="stylesheet" href="~/css/project-cards.css" />
<link rel="stylesheet" href="~/css/site.css" />


<!-- ===============================
     Maintenance Request Details Modal
=============================== -->
<div class="modal fade" id="maintenanceDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content construction-border"
         style="background-color: var(--secondary-bg); color: var(--text-light); border-radius: 12px;">
      <div class="modal-header" style="background: var(--primary-bg); border-bottom: 1px solid var(--accent-yellow);">
        <h5 class="modal-title" style="color: var(--accent-yellow); font-weight: 600;">
          <i class="fa-solid fa-wrench me-2"></i> Maintenance Request Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="maintenanceDetailsBody">
        <p class="text-center py-3 text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- ===============================
     New Maintenance Request Modal
=============================== -->
<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content construction-border"
         style="background-color: var(--secondary-bg); color: var(--text-light); border-radius: 12px;">
      <div class="modal-header"
           style="background: var(--primary-bg); border-bottom: 1px solid var(--accent-yellow);">
        <h5 class="modal-title" style="color: var(--accent-yellow); font-weight: 600;">
          <i class="fa-solid fa-plus-circle me-2"></i> New Maintenance Request
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="maintenanceForm" onsubmit="submitMaintenanceRequest(event)">
          <div class="mb-3">
            <label class="form-label">Project</label>
            <select id="projectSelect" class="form-select">
            <option value="">Select Project</option>
            @foreach (var project in Model.Projects.Where(p => p.Status == "Completed"))
            {
                <option value="@project.ProjectId">@project.Name</option>
            }
            </select>

            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Priority</label>
            <select id="prioritySelect" class="form-select">
              <option value="">Select Priority</option>
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="descriptionInput" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Attach Image (optional)</label>
            <input type="file" id="mediaFile" class="form-control" accept="image/*">
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-warning">
              <i class="fa-solid fa-paper-plane me-2"></i> Submit Request
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- üß± Project Details Modal -->
<div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content construction-border"
         style="background-color: var(--secondary-bg); color: var(--text-light); border-radius: 12px;">
      <div class="modal-header" style="background: var(--primary-bg); border-bottom: 1px solid var(--accent-yellow);">
        <h5 class="modal-title" style="color: var(--accent-yellow); font-weight: 600;">
          <i class="fa-solid fa-building me-2"></i> Project Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="projectDetailsBody">
        <p class="text-center py-3 text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- üßæ Quotation Details Modal -->
<div class="modal fade" id="quotationDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content construction-border"
         style="background-color: var(--secondary-bg); color: var(--text-light); border-radius: 12px;">
      <div class="modal-header" style="background: var(--primary-bg); border-bottom: 1px solid var(--accent-yellow);">
        <h5 class="modal-title" style="color: var(--accent-yellow); font-weight: 600;">
          <i class="fa-solid fa-file-invoice-dollar me-2"></i> Quotation Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="quotationDetailsBody">
        <p class="text-center py-3 text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>



<!-- ===============================
     Image Preview Modal
=============================== -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body text-center p-0">
        <img id="modalImage" src="" class="img-fluid rounded" alt="Preview" />
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üß≠ Client Dashboard initialized");
            initializeClientDashboard();
        });

        // ==========================
        // üîπ MAIN INITIALIZER
        // ==========================
        function initializeClientDashboard() {
            setupFilterToggle();
            setupSearchBar();
            console.log("‚úÖ Dashboard ready");
        }

        // ==========================
        // üîπ FILTER PANEL TOGGLE
        // ==========================
        function setupFilterToggle() {
            const toggleBtn = document.querySelector(".filter-toggle-btn");
            const panel = document.getElementById("filtersPanel");
            const icon = document.getElementById("filterToggleIcon");
            const text = document.getElementById("filterToggleText");

            toggleBtn?.addEventListener("click", () => {
                const visible = panel.style.display === "block";
                panel.style.display = visible ? "none" : "block";
                icon.classList.toggle("fa-chevron-up", !visible);
                icon.classList.toggle("fa-chevron-down", visible);
                text.textContent = visible ? "Show Filters" : "Hide Filters";
            });
        }

        // ==========================
        // üîπ SEARCH BAR LOGIC
        // ==========================
        function setupSearchBar() {
            const searchInput = document.getElementById("searchInput");
            const searchBtn = document.getElementById("searchBtn");
            const clearBtn = document.getElementById("clearSearchBtn");

            searchBtn?.addEventListener("click", () => applySearch(searchInput.value));
            clearBtn?.addEventListener("click", () => {
                searchInput.value = "";
                applySearch("");
            });
        }

        function applySearch(query) {
            console.log("üîç Searching for:", query);
            query = query.toLowerCase();

            const allCards = document.querySelectorAll(".projects-grid .project-card, .projects-grid .quotation-card");
            allCards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(query) ? "block" : "none";
            });
        }

        // ==========================
        // üîπ APPLY / CLEAR FILTERS
        // ==========================
        function applyClientFilters() {
            const status = document.querySelector(".status-filter-btn.active")?.dataset.status;
            const start = document.getElementById("filterStart").value;
            const end = document.getElementById("filterEnd").value;

            console.log("üéØ Applying filters:", { status, start, end });

            const allCards = document.querySelectorAll(".projects-grid .project-card");
            allCards.forEach(card => {
                const cardStatus = card.querySelector(".status-badge")?.innerText.trim().toLowerCase();
                let visible = true;

                if (status && status !== "All" && cardStatus !== status.toLowerCase())
                    visible = false;

                // Extend here for date comparisons if available
                card.style.display = visible ? "block" : "none";
            });
        }

        function clearClientFilters() {
            console.log("‚ôªÔ∏è Clearing filters");
            document.getElementById("filterStart").value = "";
            document.getElementById("filterEnd").value = "";
            document.querySelectorAll(".status-filter-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelectorAll(".projects-grid .project-card").forEach(card => (card.style.display = "block"));
        }

        // ==========================
        // üîπ MAINTENANCE FORM TOGGLE
        // ==========================
        function showMaintenanceForm() {
            console.log("üß© Showing maintenance form");
            const modal = new bootstrap.Modal(document.getElementById("maintenanceModal"));
            modal.show();
        }

        // ==========================
        // üîπ IMAGE MODAL PREVIEW
        // ==========================
        function showImageModal(url) {
            console.log("üñºÔ∏è Opening image modal:", url);
            document.getElementById("modalImage").src = url;
            const modal = new bootstrap.Modal(document.getElementById("imageModal"));
            modal.show();
        }

        // ==========================
        // üîπ SUBMIT MAINTENANCE FORM
        // ==========================
        async function submitMaintenanceRequest(event) {
        event.preventDefault();

        const form = event.target;
        const projectId = form.querySelector("#projectSelect")?.value;
        const priority = form.querySelector("#prioritySelect")?.value;
        const description = form.querySelector("#descriptionInput")?.value;
        const file = form.querySelector("#mediaFile")?.files[0];

        console.log("üì§ Submitting maintenance request:", { projectId, priority, description, file });

        let mediaUrl = "";

        try {
            // ‚úÖ 1. Upload to Supabase via DocumentsController
            if (file) {
                console.log("üìÅ Uploading to Supabase...");
                const formData = new FormData();
                formData.append("file", file);
                formData.append("projectId", projectId || "");
                formData.append("description", description || "");

                const uploadRes = await fetch("/Clients/UploadDocument", {
                method: "POST",
                body: formData
                });



                if (uploadRes.ok) {
                    const data = await uploadRes.json();
                    mediaUrl = data.fileUrl; // ‚Üê Supabase public URL
                    console.log("‚úÖ Uploaded file to Supabase:", mediaUrl);
                } else {
                    console.error("‚ùå Upload failed:", uploadRes.status);
                    alert("File upload failed.");
                    return;
                }
            }

            // ‚úÖ 2. Create the maintenance request (same as before)
            const payload = { projectId, priority, description, mediaUrl };
            const res = await fetch("/Clients/CreateMaintenanceRequest", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                console.log("‚úÖ Request created successfully");
                alert("Maintenance request submitted!");
                location.reload();
            } else {
                console.error("‚ùå Request failed:", res.status);
                alert("Failed to create request.");
            }
        } catch (err) {
            console.error("üî• Unexpected error:", err);
            alert("Error: " + err.message);
        }
}


async function openMaintenanceDetails(requestId) {
    console.log("üìÇ Opening maintenance details modal for:", requestId);

    const modal = new bootstrap.Modal(document.getElementById("maintenanceDetailsModal"));
    const body = document.getElementById("maintenanceDetailsBody");
    body.innerHTML = "<p class='text-center py-3 text-muted'>Loading...</p>";

    try {
        const res = await fetch(`/Clients/MaintenanceRequestDetailsPartial/${requestId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        body.innerHTML = await res.text();
        modal.show();
    } catch (err) {
        console.error("‚ùå Failed to load details:", err);
        body.innerHTML = "<p class='text-danger text-center'>Failed to load details.</p>";
        modal.show();
    }
}

async function openProjectDetails(projectId) {
    console.log("üèó Opening project details for:", projectId);
    const modalElement = document.getElementById("projectDetailsModal");
    const body = document.getElementById("projectDetailsBody");
    if (!modalElement) {
        console.error("‚ùå Modal element not found in DOM");
        return;
    }

    const modal = new bootstrap.Modal(modalElement);
    body.innerHTML = "<p class='text-center py-3 text-muted'>Loading...</p>";

    try {
        const res = await fetch(`/Clients/ProjectDetailsPartial/${projectId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        body.innerHTML = await res.text();
        modal.show();
    } catch (err) {
        console.error("‚ùå Failed to load project details:", err);
        body.innerHTML = "<p class='text-danger text-center'>Failed to load details.</p>";
        modal.show();
    }
}

async function openQuotationDetails(quotationId) {
    console.log("üìÑ Opening quotation details for:", quotationId);

    const modalEl = document.getElementById("quotationDetailsModal");
    const body = document.getElementById("quotationDetailsBody");
    if (!modalEl) {
        console.error("‚ùå quotationDetailsModal missing in DOM");
        return;
    }

    const modal = new bootstrap.Modal(modalEl);
    body.innerHTML = "<p class='text-center py-3 text-muted'>Loading...</p>";

    try {
        const res = await fetch(`/Clients/QuotationDetailsPartial/${quotationId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        body.innerHTML = await res.text();
        modal.show();
    } catch (err) {
        console.error("‚ùå Failed to load quotation details:", err);
        body.innerHTML = "<p class='text-danger text-center'>Failed to load details.</p>";
        modal.show();
    }
}


function closeDetailsPanel() {
    const overlay = document.getElementById("dynamicDetailsOverlay");
    if (!overlay) return;
    const panel = overlay.querySelector(".details-panel");
    panel.classList.remove("active");
    setTimeout(() => overlay.remove(), 350);
}

    console.log("üßæ [Init] downloadQuotation script loaded");

    function downloadQuotation(id) {
        console.log("üß© [downloadQuotation] Function triggered");
        console.log("üì¶ [Param] Quotation ID received:", id);

        if (!id) {
            console.warn("‚ö†Ô∏è [downloadQuotation] No quotation ID provided");
            alert("Quotation ID missing");
            return;
        }

        const url = `/Clients/DownloadQuotation/${id}`;
        console.log("üåê [downloadQuotation] Navigating to:", url);

        try {
            window.location.href = url;
            console.log("üöÄ [downloadQuotation] Redirect initiated successfully");
        } catch (err) {
            console.error("üî• [downloadQuotation] Redirect failed:", err);
            alert("Failed to start download. See console for details.");
        }
    }

    </script>
}
