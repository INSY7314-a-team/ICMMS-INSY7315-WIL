@{
    ViewData["Title"] = "AI Workflow Testing Dashboard";
}

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.workflow-step {
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.workflow-step.active {
    border-color: #007bff;
    background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
    box-shadow: 0 4px 20px rgba(0,123,255,0.2);
}

.workflow-step.completed {
    border-color: #28a745;
    background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%);
}

.workflow-step.error {
    border-color: #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
    flex-shrink: 0;
}

.step-number.active {
    background: #007bff;
}

.step-number.completed {
    background: #28a745;
}

.step-number.error {
    background: #dc3545;
}

.btn-workflow {
    border-radius: 25px;
    font-weight: 600;
    padding: 0.75rem 2rem;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.9rem;
}

.btn-workflow:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.response-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-draft { background: #fff3cd; color: #856404; }
.status-pending { background: #cce5ff; color: #004085; }
.status-approved { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }

.material-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.material-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.workflow-progress {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.workflow-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    transition: width 0.5s ease;
    border-radius: 4px;
}

.alert-workflow {
    border: none;
    border-radius: 12px;
    border-left: 4px solid;
    margin-bottom: 1rem;
}

.alert-info { border-left-color: #17a2b8; background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); }
.alert-success { border-left-color: #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
.alert-warning { border-left-color: #ffc107; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); }
.alert-danger { border-left-color: #dc3545; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-primary">
                        <i class="fas fa-robot me-2"></i>
                        AI Workflow Testing Dashboard
                    </h1>
                    <p class="text-muted mb-0">Test the complete Estimate ‚Üí Quotation ‚Üí Invoice workflow</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6">Tester Role</span>
                </div>
            </div>

            <!-- Workflow Progress -->
            <div class="workflow-progress">
                <div class="workflow-progress-bar" id="workflowProgress" style="width: 0%"></div>
            </div>

            <!-- Step 1: Process Blueprint to Estimate -->
            <div class="workflow-step" id="step1">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number active" id="step1Number">1</div>
                    <div>
                        <h4 class="mb-1">Process Blueprint to AI Estimate</h4>
                        <p class="text-muted mb-0">Upload blueprint and generate AI-powered estimate with line items</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Blueprint URL</label>
                            <input type="text" class="form-control" id="blueprintUrl" 
                                   value="https://givtrrcqxteqcnmtnnkt.supabase.co/storage/v1/object/sign/upload/blueprint.pdf?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8wYjEwMjZjYi04YTM1LTRhZTktYjQxMi1kZGRiYmQ1MDVmZTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJ1cGxvYWQvYmx1ZXByaW50LnBkZiIsImlhdCI6MTc2MDY0MTQ0MiwiZXhwIjoxNzkyMTc3NDQyfQ.GiK-oUawd5-CA9Gl6CHdPJyXj3WuyCb7lJOVQOn7X-U" 
                                   placeholder="Enter Supabase blueprint URL">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Real blueprint: 1,136 sq ft house with garage and foundation plans
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Project ID</label>
                            <input type="text" class="form-control" id="projectId" 
                                   value="project123" placeholder="Enter project ID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contractor ID</label>
                            <input type="text" class="form-control" id="contractorId" 
                                   value="contractor789" placeholder="Enter contractor ID">
                        </div>
                        <button class="btn btn-primary btn-workflow" onclick="processBlueprint()">
                            <i class="fas fa-robot me-2"></i>Process Blueprint
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="response-box" id="step1Response">
                            <div class="text-muted">Click "Process Blueprint" to generate AI estimate...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Review and Edit Estimate -->
            <div class="workflow-step" id="step2">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="step2Number">2</div>
                    <div>
                        <h4 class="mb-1">Review AI-Generated Line Items</h4>
                        <p class="text-muted mb-0">Review and edit the AI-generated estimate line items</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div id="estimateLineItems">
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Complete Step 1 to see AI-generated line items
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <button class="btn btn-success btn-workflow" onclick="convertToQuotation()" id="convertBtn" disabled>
                                <i class="fas fa-arrow-right me-2"></i>Convert to Quotation
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Create Quotation from Estimate -->
            <div class="workflow-step" id="step3">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="step3Number">3</div>
                    <div>
                        <h4 class="mb-1">Create Quotation</h4>
                        <p class="text-muted mb-0">Convert estimate to quotation and prepare for PM review</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-control" id="clientId" 
                                   value="client456" placeholder="Enter client ID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quotation Description</label>
                            <textarea class="form-control" id="quotationDescription" rows="3" 
                                      placeholder="Enter quotation description">AI-generated quotation from blueprint analysis</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valid Until</label>
                            <input type="datetime-local" class="form-control" id="validUntil" 
                                   value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-ddTHH:mm")">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="response-box" id="step3Response">
                            <div class="text-muted">Complete previous steps to create quotation...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: PM Review and Approval -->
            <div class="workflow-step" id="step4">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="step4Number">4</div>
                    <div>
                        <h4 class="mb-1">PM Review & Approval</h4>
                        <p class="text-muted mb-0">Project Manager reviews and approves the quotation</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">PM Action</label>
                            <select class="form-select" id="pmAction">
                                <option value="">Select PM action...</option>
                                <option value="edit">Edit Quotation Items</option>
                                <option value="approve">Approve & Send to Client</option>
                                <option value="reject">Reject Quotation</option>
                            </select>
                        </div>
                        <div class="mb-3" id="editSection" style="display: none;">
                            <label class="form-label">Edit Notes</label>
                            <textarea class="form-control" id="pmEditNotes" rows="3" 
                                      placeholder="Enter PM edit notes..."></textarea>
                        </div>
                        <div class="mb-3" id="rejectSection" style="display: none;">
                            <label class="form-label">Rejection Reason</label>
                            <textarea class="form-control" id="pmRejectReason" rows="3" 
                                      placeholder="Enter reason for rejection..."></textarea>
                        </div>
                        <button class="btn btn-warning btn-workflow" onclick="pmReview()" id="pmReviewBtn" disabled>
                            <i class="fas fa-user-check me-2"></i>PM Review
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="response-box" id="step4Response">
                            <div class="text-muted">Complete previous steps for PM review...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Client Decision -->
            <div class="workflow-step" id="step5">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="step5Number">5</div>
                    <div>
                        <h4 class="mb-1">Client Decision</h4>
                        <p class="text-muted mb-0">Client reviews and makes decision on quotation</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Client Decision</label>
                            <select class="form-select" id="clientDecision">
                                <option value="">Select client decision...</option>
                                <option value="accept">Accept Quotation</option>
                                <option value="decline">Decline Quotation</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Client Notes</label>
                            <textarea class="form-control" id="clientNotes" rows="3" 
                                      placeholder="Enter client notes..."></textarea>
                        </div>
                        <button class="btn btn-info btn-workflow" onclick="clientDecision()" id="clientDecisionBtn" disabled>
                            <i class="fas fa-handshake me-2"></i>Client Decision
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="response-box" id="step5Response">
                            <div class="text-muted">Complete previous steps for client decision...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Generate Invoice -->
            <div class="workflow-step" id="step6">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="step6Number">6</div>
                    <div>
                        <h4 class="mb-1">Generate Invoice</h4>
                        <p class="text-muted mb-0">Create invoice from approved quotation</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoiceNumber" 
                                   value="INV-2024-001" placeholder="Enter invoice number">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" id="dueDate" 
                                   value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-ddTHH:mm")">
                        </div>
                        <button class="btn btn-success btn-workflow" onclick="generateInvoice()" id="generateInvoiceBtn" disabled>
                            <i class="fas fa-file-invoice me-2"></i>Generate Invoice
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="response-box" id="step6Response">
                            <div class="text-muted">Complete previous steps to generate invoice...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Summary -->
            <div class="workflow-step" id="summary">
                <div class="d-flex align-items-center mb-3">
                    <div class="step-number" id="summaryNumber">‚úì</div>
                    <div>
                        <h4 class="mb-1">Workflow Summary</h4>
                        <p class="text-muted mb-0">Complete workflow status and generated documents</p>
                    </div>
                </div>

                <div class="row" id="workflowSummary">
                    <div class="col-12">
                        <div class="text-muted text-center py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Complete the workflow to see summary
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Quotation Items Modal -->
<div class="modal fade" id="editQuotationModal" tabindex="-1" aria-labelledby="editQuotationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editQuotationModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Quotation Items
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Quotation Items</label>
                    <div id="quotationItemsList">
                        <!-- Items will be populated here -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addQuotationItem()">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Edit Notes</label>
                    <textarea class="form-control" id="modalEditNotes" rows="3" 
                              placeholder="Enter notes about the changes made..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuotationEdits()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentEstimateId = null;
let currentQuotationId = null;
let currentInvoiceId = null;
let workflowData = {};

// Update workflow progress
function updateProgress(step) {
    const progress = (step / 6) * 100;
    document.getElementById('workflowProgress').style.width = progress + '%';
}

// Mark step as completed
function markStepCompleted(stepNumber) {
    const step = document.getElementById(`step${stepNumber}`);
    const stepNumberEl = document.getElementById(`step${stepNumber}Number`);
    
    step.classList.remove('active', 'error');
    step.classList.add('completed');
    stepNumberEl.classList.remove('active', 'error');
    stepNumberEl.classList.add('completed');
    
    updateProgress(stepNumber);
}

// Mark step as error
function markStepError(stepNumber) {
    const step = document.getElementById(`step${stepNumber}`);
    const stepNumberEl = document.getElementById(`step${stepNumber}Number`);
    
    step.classList.remove('active', 'completed');
    step.classList.add('error');
    stepNumberEl.classList.remove('active', 'completed');
    stepNumberEl.classList.add('error');
}

// Mark step as active
function markStepActive(stepNumber) {
    const step = document.getElementById(`step${stepNumber}`);
    const stepNumberEl = document.getElementById(`step${stepNumber}Number`);
    
    step.classList.remove('completed', 'error');
    step.classList.add('active');
    stepNumberEl.classList.remove('completed', 'error');
    stepNumberEl.classList.add('active');
}

// Show response in step
function showResponse(stepNumber, response, isError = false) {
    const responseEl = document.getElementById(`step${stepNumber}Response`);
    responseEl.innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
    
    if (isError) {
        responseEl.style.borderColor = '#dc3545';
        responseEl.style.backgroundColor = '#f8d7da';
    } else {
        responseEl.style.borderColor = '#28a745';
        responseEl.style.backgroundColor = '#d4edda';
    }
}

// Step 1: Process Blueprint
async function processBlueprint() {
    try {
        markStepActive(1);
        
        const blueprintUrl = document.getElementById('blueprintUrl').value;
        const projectId = document.getElementById('projectId').value;
        const contractorId = document.getElementById('contractorId').value;
        
        console.log('üöÄ Processing Blueprint via .NET API...');
        console.log('üìÑ Blueprint URL:', blueprintUrl);
        console.log('üèóÔ∏è Project ID:', projectId);
        console.log('üë∑ Contractor ID:', contractorId);

        // Call .NET API (which will then call GenKitMicroservice)
        const apiData = {
            blueprintUrl: blueprintUrl,
            projectId: projectId,
            contractorId: contractorId
        };

        console.log('ü§ñ Calling .NET API (which calls GenKitMicroservice)...');
        const response = await fetch('https://localhost:7136/api/estimates/process-blueprint', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + await getAuthToken()
            },
            body: JSON.stringify(apiData)
        });

        let result;
        const responseText = await response.text();
        
        console.log('.NET API Response Status:', response.status);
        console.log('.NET API Response Text:', responseText);
        
        if (responseText) {
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('.NET API JSON Parse Error:', parseError);
                throw new Error(`Invalid JSON response: ${responseText}`);
            }
        } else {
            result = { message: 'Empty response from .NET API' };
        }
        
        if (response.ok) {
            console.log('‚úÖ .NET API processing successful!');
            console.log('üìä Total items:', result.lineItems?.length || 0);
            console.log('üí∞ Total amount:', result.totalAmount || 0);
            
            // Log all materials found
            if (result.lineItems) {
                console.log('üìã All line items found:', result.lineItems.length);
                result.lineItems.forEach(item => {
                    console.log(`  - ${item.name}: ${item.quantity} ${item.unit} (${item.category})`);
                });
            }
            
            // Create estimate data structure
            const estimateData = {
                estimateId: result.estimateId || `EST_${Date.now()}`,
                projectId: projectId,
                contractorId: contractorId,
                lineItems: result.lineItems || [],
                summary: {
                    totalValue: result.totalAmount || 0,
                    totalItems: result.lineItems?.length || 0,
                    processingTime: 0, // .NET API doesn't provide this
                    confidence: 0.8
                },
                createdAt: new Date().toISOString()
            };
            console.log('Estimate Data:', estimateData);
            currentEstimateId = estimateData.estimateId;
            workflowData.estimate = estimateData;
            
            showResponse(1, result);
            displayEstimateLineItems(result.lineItems || []);
            markStepCompleted(1);
            
            // Enable next step
            document.getElementById('convertBtn').disabled = false;
            markStepActive(2);
        } else {
            throw new Error(result.error || '.NET API processing failed');
        }
    } catch (error) {
        console.error('‚ùå Blueprint processing failed:', error);
        showResponse(1, { error: error.message }, true);
        markStepError(1);
    }
}

// Display estimate line items with pagination
function displayEstimateLineItems(lineItems) {
    const container = document.getElementById('estimateLineItems');
    
    if (!lineItems || lineItems.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-4">No line items found</div>';
        return;
    }

    console.log('üìã Displaying AI-generated line items:', lineItems.length, 'items');
    console.log('üìã Line items data:', lineItems);

    // Store line items globally for pagination
    window.allLineItems = lineItems;
    window.currentPage = 1;
    window.itemsPerPage = 5;

    // Separate general and material items based on the AI categorization
    const generalItems = lineItems.filter(item => 
        item.itemType === 'General' || 
        item.category === 'General' || 
        (item.name && (
            item.name.toLowerCase().includes('preparation') ||
            item.name.toLowerCase().includes('management') ||
            item.name.toLowerCase().includes('supervision') ||
            item.name.toLowerCase().includes('utilities') ||
            item.name.toLowerCase().includes('equipment') ||
            item.name.toLowerCase().includes('safety') ||
            item.name.toLowerCase().includes('permits')
        ))
    );
    
    const materialItems = lineItems.filter(item => 
        item.itemType === 'Material' || 
        (item.category !== 'General' && 
         item.itemType !== 'General' && 
         !(item.name && (
            item.name.toLowerCase().includes('preparation') ||
            item.name.toLowerCase().includes('management') ||
            item.name.toLowerCase().includes('supervision') ||
            item.name.toLowerCase().includes('utilities') ||
            item.name.toLowerCase().includes('equipment') ||
            item.name.toLowerCase().includes('safety') ||
            item.name.toLowerCase().includes('permits')
         )))
    );

    console.log('üîß General work items:', generalItems.length);
    console.log('üß± Material items:', materialItems.length);

    // Store separated items globally
    window.generalItems = generalItems;
    window.materialItems = materialItems;

    // Render the first page
    renderLineItemsPage();
    
    // Store line items for workflow tracking
    workflowData.estimateLineItems = lineItems;
    console.log('üíæ Stored line items in workflow data:', workflowData.estimateLineItems.length, 'items');
}

// Render line items with pagination
function renderLineItemsPage() {
    const container = document.getElementById('estimateLineItems');
    const currentPage = window.currentPage || 1;
    const itemsPerPage = window.itemsPerPage || 5;
    const allItems = window.allLineItems || [];
    const generalItems = window.generalItems || [];
    const materialItems = window.materialItems || [];

    // Calculate pagination
    const totalPages = Math.ceil(allItems.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, allItems.length);
    const currentItems = allItems.slice(startIndex, endIndex);

    // Separate current page items
    const currentGeneralItems = currentItems.filter(item => 
        item.itemType === 'General' || 
        item.category === 'General' || 
        (item.name && (
            item.name.toLowerCase().includes('preparation') ||
            item.name.toLowerCase().includes('management') ||
            item.name.toLowerCase().includes('supervision') ||
            item.name.toLowerCase().includes('utilities') ||
            item.name.toLowerCase().includes('equipment') ||
            item.name.toLowerCase().includes('safety') ||
            item.name.toLowerCase().includes('permits')
        ))
    );
    
    const currentMaterialItems = currentItems.filter(item => 
        item.itemType === 'Material' || 
        (item.category !== 'General' && 
         item.itemType !== 'General' && 
         !(item.name && (
            item.name.toLowerCase().includes('preparation') ||
            item.name.toLowerCase().includes('management') ||
            item.name.toLowerCase().includes('supervision') ||
            item.name.toLowerCase().includes('utilities') ||
            item.name.toLowerCase().includes('equipment') ||
            item.name.toLowerCase().includes('safety') ||
            item.name.toLowerCase().includes('permits')
         )))
    );

    let html = '<div class="row">';
    
    // Show General Work Items first
    if (currentGeneralItems.length > 0) {
        html += '<div class="col-12 mb-4">';
        html += '<h5 class="text-primary mb-3"><i class="fas fa-tools me-2"></i>General Work Items</h5>';
        html += '<div class="row">';
        
        currentGeneralItems.forEach((item, index) => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="material-item" style="border-left: 4px solid #007bff;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1 text-primary">${item.name || 'Unnamed Work Item'}</h6>
                            <span class="badge bg-primary">General Work</span>
                        </div>
                        <p class="text-muted small mb-2">${item.description || 'No description available'}</p>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Quantity: ${item.quantity || 0} ${item.unit || 'N/A'}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Unit Price: R${(item.unitPrice || 0).toFixed(2)}</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong class="text-primary">Line Total: R${(item.lineTotal || 0).toFixed(2)}</strong>
                        </div>
                        ${item.isAiGenerated ? `<div class="mt-1"><small class="text-info">AI Confidence: ${((item.aiConfidence || 0) * 100).toFixed(1)}%</small></div>` : ''}
                        ${item.notes ? `<div class="mt-1"><small class="text-muted">Notes: ${item.notes}</small></div>` : ''}
                        <div class="mt-1"><small class="text-muted">ID: ${item.itemId || item.id || 'N/A'}</small></div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
    }

    // Show Material Items
    if (currentMaterialItems.length > 0) {
        html += '<div class="col-12 mb-4">';
        html += '<h5 class="text-success mb-3"><i class="fas fa-cube me-2"></i>Material Items</h5>';
        html += '<div class="row">';
        
        currentMaterialItems.forEach((item, index) => {
            // Get category-based styling
            const categoryColors = {
                'Foundation': '#8B4513',    // Brown
                'Walls': '#228B22',         // Forest Green
                'Roof': '#DC143C',          // Crimson
                'Electrical': '#FFD700',    // Gold
                'Plumbing': '#00CED1',      // Dark Turquoise
                'HVAC': '#FF6347',          // Tomato
                'Flooring': '#9370DB',      // Medium Purple
                'Fixtures': '#20B2AA',      // Light Sea Green
                'Walls': '#32CD32',         // Lime Green
                'Ceilings': '#FF69B4'       // Hot Pink
            };
            
            const borderColor = categoryColors[item.category] || '#6c757d';
            const textColor = 'text-secondary';
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="material-item" style="border-left: 4px solid ${borderColor};">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1 ${textColor}">${item.name || 'Unnamed Material'}</h6>
                            <span class="badge bg-secondary">${item.category || 'Material'}</span>
                        </div>
                        <p class="text-muted small mb-2">${item.description || 'No description available'}</p>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Quantity: ${item.quantity || 0} ${item.unitOfQuantity || item.unit || 'N/A'}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Unit Price: R${(item.unitPrice || 0).toFixed(2)}</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong class="${textColor}">Line Total: R${(item.lineTotal || 0).toFixed(2)}</strong>
                        </div>
                        ${item.isAiGenerated ? `<div class="mt-1"><small class="text-info">AI Confidence: ${((item.aiConfidence || 0) * 100).toFixed(1)}%</small></div>` : ''}
                        ${item.notes ? `<div class="mt-1"><small class="text-muted">Notes: ${item.notes}</small></div>` : ''}
                        <div class="mt-1"><small class="text-muted">ID: ${item.itemId || item.id || 'N/A'}</small></div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
    }

    html += '</div>';
    
    // Add pagination controls
    html += `
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="text-muted">
                                    Showing ${startIndex + 1}-${endIndex} of ${allItems.length} line items
                                </span>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        onclick="changePage(${currentPage - 1})" 
                                        ${currentPage <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span class="btn btn-outline-secondary btn-sm disabled">
                                    Page ${currentPage} of ${totalPages}
                                </span>
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        onclick="changePage(${currentPage + 1})" 
                                        ${currentPage >= totalPages ? 'disabled' : ''}>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add comprehensive summary
    const totalValue = allItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    const generalValue = generalItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    const materialValue = materialItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    
    html += `
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title text-info"><i class="fas fa-chart-bar me-2"></i>AI Estimate Summary</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 class="text-primary">R${generalValue.toFixed(2)}</h5>
                                    <small class="text-muted">General Work Items (${generalItems.length})</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 class="text-success">R${materialValue.toFixed(2)}</h5>
                                    <small class="text-muted">Material Items (${materialItems.length})</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h5 class="text-info">R${totalValue.toFixed(2)}</h5>
                                    <small class="text-muted">Total Estimate (${allItems.length})</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-robot me-1"></i>
                                Generated by AI with South African pricing and material categorization
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Change page function
function changePage(newPage) {
    const totalPages = Math.ceil((window.allLineItems || []).length / (window.itemsPerPage || 5));
    
    if (newPage >= 1 && newPage <= totalPages) {
        window.currentPage = newPage;
        renderLineItemsPage();
    }
}

// Display quotation line items
function displayQuotationLineItems(lineItems) {
    console.log('üìã Displaying quotation line items:', lineItems.length, 'items');
    
    // For now, quotation line items are the same as estimate line items
    // In a real implementation, you might fetch the actual quotation data
    workflowData.quotationLineItems = lineItems;
    
    // You could add a separate container for quotation items if needed
    // For now, we'll just log that quotation items are ready
    console.log('‚úÖ Quotation line items ready for PM review');
}

// Display invoice line items
function displayInvoiceLineItems(lineItems) {
    console.log('üìã Displaying invoice line items:', lineItems.length, 'items');
    
    // Store invoice line items
    workflowData.invoiceLineItems = lineItems;
    
    // You could add a separate container for invoice items if needed
    // For now, we'll just log that invoice items are ready
    console.log('‚úÖ Invoice line items ready for payment');
}

// Step 2: Convert to Quotation
async function convertToQuotation() {
    try {
        if (!currentEstimateId) {
            throw new Error('No estimate available. Please complete Step 1 first.');
        }

        const requestData = {
            clientId: document.getElementById('clientId').value
        };

        const response = await fetch(`https://localhost:7136/api/quotations/from-estimate/${currentEstimateId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + await getAuthToken()
            },
            body: JSON.stringify(requestData)
        });

        let result;
        const responseText = await response.text();
        
        console.log('Convert to Quotation - API Response Status:', response.status);
        console.log('Convert to Quotation - API Response Text:', responseText);
        

        if (responseText) {
            try {
                // Try to parse as JSON first
                result = JSON.parse(responseText);
            } catch (parseError) {
                // If it's not JSON, treat it as a string ID
                console.log('Convert to Quotation - Response is not JSON, treating as string ID');
                result = responseText; // This is the quotation ID
            }
        } else {
            result = { message: 'Empty response from server' };
        }
        
        if (response.ok) {
            // Handle both string ID and JSON object responses
            const quotationId = typeof result === 'string' ? result : result.quotationId || result;
            currentQuotationId = quotationId;
            workflowData.quotationId = quotationId;
            
            console.log('‚úÖ Quotation created successfully:', quotationId);
            
            // Display quotation line items (same as estimate for now)
            if (workflowData.estimateLineItems) {
                displayQuotationLineItems(workflowData.estimateLineItems);
            }
            
            showResponse(3, { quotationId: quotationId, message: 'Quotation created successfully' });
            markStepCompleted(2);
            markStepCompleted(3);
            
            // Enable next step
            document.getElementById('pmReviewBtn').disabled = false;
            markStepActive(4);
        } else {
            throw new Error(result.message || 'Failed to create quotation');
        }
    } catch (error) {
        showResponse(3, { error: error.message }, true);
        markStepError(3);
    }
}

// Step 4: PM Review
async function pmReview() {
    try {
        if (!currentQuotationId) {
            throw new Error('No quotation available. Please complete previous steps first.');
        }

        const action = document.getElementById('pmAction').value;
        if (!action) {
            throw new Error('Please select a PM action');
        }

        let response;
        let result;

        if (action === 'approve') {
            response = await fetch(`https://localhost:7136/api/quotations/${currentQuotationId}/pm-approve`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + await getAuthToken()
                }
            });
            
            const responseText = await response.text();
            console.log('PM Review - API Response Status:', response.status);
            console.log('PM Review - API Response Text:', responseText);
            
            if (responseText) {
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
            } else {
                // Empty response is OK for PM approval - it means success
                result = { message: 'PM approval successful' };
            }
        } else if (action === 'edit') {
            // Open the edit modal
            openEditModal();
            return; // Exit early for edit action - modal will handle the rest
        } else if (action === 'reject') {
            // For rejection, call the API
            const rejectReason = document.getElementById('pmRejectReason').value;
            
            response = await fetch(`https://localhost:7136/api/quotations/${currentQuotationId}/pm-reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + await getAuthToken()
                },
                body: JSON.stringify({ reason: rejectReason })
            });
            
            const responseText = await response.text();
            console.log('PM Reject - API Response Status:', response.status);
            console.log('PM Reject - API Response Text:', responseText);
            
            if (responseText) {
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
            } else {
                // Empty response is OK for PM rejection - it means success
                result = { message: 'Quotation rejected successfully', reason: rejectReason };
            }
            
            if (response.ok) {
                showResponse(4, result);
                markStepError(4); // Mark as error since it's rejected
                showResponse(5, { message: 'Workflow stopped - Quotation rejected by PM' }, true);
                return; // Exit early for reject action - workflow stops here
            } else {
                throw new Error(result.message || 'PM rejection failed');
            }
        }

        if (response && response.ok) {
            showResponse(4, result);
            markStepCompleted(4);
            
            // Enable next step
            document.getElementById('clientDecisionBtn').disabled = false;
            markStepActive(5);
        } else {
            throw new Error(result.message || 'PM review failed');
        }
    } catch (error) {
        showResponse(4, { error: error.message }, true);
        markStepError(4);
    }
}

// Step 5: Client Decision
async function clientDecision() {
    try {
        if (!currentQuotationId) {
            throw new Error('No quotation available. Please complete previous steps first.');
        }

        const decision = document.getElementById('clientDecision').value;
        const notes = document.getElementById('clientNotes').value;
        
        if (!decision) {
            throw new Error('Please select a client decision');
        }

        const requestData = {
            accept: decision === 'accept',
            note: notes
        };

        const response = await fetch(`https://localhost:7136/api/quotations/${currentQuotationId}/client-decision`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + await getAuthToken()
            },
            body: JSON.stringify(requestData)
        });

        let result;
        const responseText = await response.text();
        
        console.log('Client Decision - API Response Status:', response.status);
        console.log('Client Decision - API Response Text:', responseText);
        
        if (responseText) {
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                throw new Error(`Invalid JSON response: ${responseText}`);
            }
        } else {
            // Empty response is OK for client decision - it means success
            result = { message: 'Client decision processed successfully' };
        }
        
        if (response.ok) {
            console.log('Client Decision - Success response, result:', result);
            showResponse(5, result);
            
            if (decision === 'accept') {
                markStepCompleted(5);
                // Enable next step
                document.getElementById('generateInvoiceBtn').disabled = false;
                markStepActive(6);
            } else {
                markStepError(5);
                showResponse(5, { message: 'Quotation declined. Workflow stopped.' }, true);
            }
        } else {
            console.log('Client Decision - Error response, status:', response.status, 'result:', result);
            throw new Error(result.message || 'Client decision failed');
        }
    } catch (error) {
        showResponse(5, { error: error.message }, true);
        markStepError(5);
    }
}

// Step 6: Generate Invoice
async function generateInvoice() {
    try {
        if (!currentQuotationId) {
            throw new Error('No quotation available. Please complete previous steps first.');
        }

        // First convert quotation to invoice
        const response = await fetch(`https://localhost:7136/api/quotations/${currentQuotationId}/convert-to-invoice`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + await getAuthToken()
            }
        });

        let result;
        const responseText = await response.text();
        
        if (responseText) {
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                throw new Error(`Invalid JSON response: ${responseText}`);
            }
        } else {
            result = { message: 'Empty response from server' };
        }
        
        if (response.ok) {
            currentInvoiceId = result;
            workflowData.invoiceId = result;
            
            console.log('‚úÖ Invoice generated successfully:', result);
            
            // Display invoice line items
            if (workflowData.quotationLineItems) {
                displayInvoiceLineItems(workflowData.quotationLineItems);
            }
            
            showResponse(6, { invoiceId: result, message: 'Invoice generated successfully' });
            markStepCompleted(6);
            
            // Show workflow summary
            showWorkflowSummary();
        } else {
            throw new Error(result.message || 'Failed to generate invoice');
        }
    } catch (error) {
        showResponse(6, { error: error.message }, true);
        markStepError(6);
    }
}

// Show workflow summary
function showWorkflowSummary() {
    const summaryEl = document.getElementById('workflowSummary');
    
    // Calculate totals from line items
    const estimateItems = workflowData.estimateLineItems || [];
    const quotationItems = workflowData.quotationLineItems || [];
    const invoiceItems = workflowData.invoiceLineItems || [];
    
    const estimateTotal = estimateItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    const quotationTotal = quotationItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    const invoiceTotal = invoiceItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
    
    // Count material items by category
    const materialCount = estimateItems.filter(item => 
        item.category && item.category !== 'General'
    ).length;
    
    summaryEl.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">AI Estimate</h5>
                        <p class="card-text">Generated from blueprint</p>
                        <small class="text-muted">ID: ${workflowData.estimate?.estimateId || 'N/A'}</small>
                        <div class="mt-2">
                            <strong class="text-primary">R${estimateTotal.toFixed(2)}</strong>
                            <br><small class="text-muted">${estimateItems.length} line items</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-file-invoice fa-2x text-info mb-2"></i>
                        <h5 class="card-title">Quotation</h5>
                        <p class="card-text">PM approved & client accepted</p>
                        <small class="text-muted">ID: ${workflowData.quotationId || 'N/A'}</small>
                        <div class="mt-2">
                            <strong class="text-info">R${quotationTotal.toFixed(2)}</strong>
                            <br><small class="text-muted">${quotationItems.length} line items</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-receipt fa-2x text-success mb-2"></i>
                        <h5 class="card-title">Invoice</h5>
                        <p class="card-text">Ready for payment</p>
                        <small class="text-muted">ID: ${workflowData.invoiceId || 'N/A'}</small>
                        <div class="mt-2">
                            <strong class="text-success">R${invoiceTotal.toFixed(2)}</strong>
                            <br><small class="text-muted">${invoiceItems.length} line items</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title text-info"><i class="fas fa-chart-line me-2"></i>AI Workflow Analytics</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-primary">${estimateItems.length}</h5>
                                    <small class="text-muted">Total Line Items</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-success">${materialCount}</h5>
                                    <small class="text-muted">Material Items</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-info">${estimateItems.filter(item => item.isAiGenerated).length}</h5>
                                    <small class="text-muted">AI Generated</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-warning">R${estimateTotal.toFixed(2)}</h5>
                                    <small class="text-muted">Total Value</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>Workflow Completed Successfully!</h5>
                <p class="mb-0">The complete AI-powered construction workflow has been tested from blueprint processing to invoice generation. All line items have been properly tracked through the entire workflow.</p>
            </div>
        </div>
    `;
}

// Get auth token from Firebase
async function getAuthToken() {
    try {
        // Check if Firebase is available and user is signed in
        if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            console.log('Firebase user found:', user.email);
            const token = await user.getIdToken();
            console.log('Firebase token obtained');
            return token;
        }
        
        console.warn('No Firebase user found, checking localStorage...');
        
        // Fallback to localStorage if available
        const storedToken = localStorage.getItem('authToken');
        if (storedToken) {
            console.log('Using stored token from localStorage');
            return storedToken;
        }
        
        // For testing purposes, return a test token
        console.warn('No valid auth token found, using test token');
        return 'test-token';
    } catch (error) {
        console.error('Error getting auth token:', error);
        return 'test-token';
    }
}

// Show/hide sections based on PM action
document.getElementById('pmAction').addEventListener('change', function() {
    const editSection = document.getElementById('editSection');
    const rejectSection = document.getElementById('rejectSection');
    
    // Hide all sections first
    editSection.style.display = 'none';
    rejectSection.style.display = 'none';
    
    // Show appropriate section based on selection
    if (this.value === 'edit') {
        editSection.style.display = 'block';
    } else if (this.value === 'reject') {
        rejectSection.style.display = 'block';
    }
});

// Edit Quotation Items Functions
let quotationItems = [];

function openEditModal() {
    // Load current quotation items
    loadQuotationItems();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editQuotationModal'));
    modal.show();
}

function loadQuotationItems() {
    // This would normally load from the current quotation
    // For now, we'll use sample data
    quotationItems = [
        { name: 'Cement (Portland)', quantity: 100, unit: 'KG', unitPrice: 2.50, lineTotal: 250.00 },
        { name: 'Bricks (Standard Red)', quantity: 4000, unit: 'PIECE', unitPrice: 3.00, lineTotal: 12000.00 },
        { name: 'Paint (White Emulsion)', quantity: 30, unit: 'LITER', unitPrice: 80.00, lineTotal: 2400.00 }
    ];
    
    renderQuotationItems();
}

function renderQuotationItems() {
    const container = document.getElementById('quotationItemsList');
    container.innerHTML = '';
    
    // Add column headers
    const headerDiv = document.createElement('div');
    headerDiv.className = 'row mb-2 fw-bold text-muted';
    headerDiv.innerHTML = `
        <div class="col-md-4">Item Name</div>
        <div class="col-md-2">Quantity</div>
        <div class="col-md-2">Unit</div>
        <div class="col-md-2">Unit Price</div>
        <div class="col-md-1">Total</div>
        <div class="col-md-1">Action</div>
    `;
    container.appendChild(headerDiv);
    
    quotationItems.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'card mb-2';
        itemDiv.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" value="${item.name}" 
                               onchange="updateQuotationItem(${index}, 'name', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" value="${item.quantity}" 
                               onchange="updateQuotationItem(${index}, 'quantity', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" value="${item.unit}" 
                               onchange="updateQuotationItem(${index}, 'unit', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" value="${item.unitPrice}" step="0.01"
                               onchange="updateQuotationItem(${index}, 'unitPrice', this.value)">
                    </div>
                    <div class="col-md-1">
                        <span class="form-control-plaintext">${item.lineTotal.toFixed(2)}</span>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuotationItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(itemDiv);
    });
}

function updateQuotationItem(index, field, value) {
    if (field === 'quantity' || field === 'unitPrice') {
        quotationItems[index][field] = parseFloat(value) || 0;
        quotationItems[index].lineTotal = quotationItems[index].quantity * quotationItems[index].unitPrice;
    } else {
        quotationItems[index][field] = value;
    }
    
    // Re-render to update line totals
    renderQuotationItems();
}

function addQuotationItem() {
    quotationItems.push({
        name: 'New Item',
        quantity: 1,
        unit: 'PIECE',
        unitPrice: 0.00,
        lineTotal: 0.00
    });
    renderQuotationItems();
}

function removeQuotationItem(index) {
    quotationItems.splice(index, 1);
    renderQuotationItems();
}

function saveQuotationEdits() {
    const editNotes = document.getElementById('modalEditNotes').value;
    
    // Calculate totals
    const subtotal = quotationItems.reduce((sum, item) => sum + item.lineTotal, 0);
    const taxTotal = subtotal * 0.15; // 15% VAT
    const grandTotal = subtotal + taxTotal;
    
    const result = {
        message: 'Quotation edited successfully',
        editNotes: editNotes,
        items: quotationItems,
        subtotal: subtotal,
        taxTotal: taxTotal,
        grandTotal: grandTotal
    };
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editQuotationModal'));
    modal.hide();
    
    // Show result
    showResponse(4, result);
    markStepCompleted(4);
    
    // Enable next step
    document.getElementById('clientDecisionBtn').disabled = false;
    markStepActive(5);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    markStepActive(1);
});
</script>
