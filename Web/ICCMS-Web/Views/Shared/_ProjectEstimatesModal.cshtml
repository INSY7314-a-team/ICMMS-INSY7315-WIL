@* Modal to view all estimates for a project *@
<div class="modal fade" id="projectEstimatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content construction-border"
            style="background-color: var(--secondary-bg); color: var(--text-light); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header"
                style="background: var(--primary-bg); border-bottom: 1px solid var(--accent-yellow); border-radius: 12px 12px 0 0; padding: 1.5rem;">
                <div class="d-flex align-items-center">
                    <div>
                        <h5 class="modal-title mb-0"
                            style="color: var(--text-light); font-weight: 600; font-size: 1.25rem;">Project Estimates
                        </h5>
                        <small class="text-muted" id="pe-projectBadge"></small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"
                    style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Loading State -->
                <div id="pe-loading" class="text-center py-5" style="display: none; padding: 3rem;">
                    <div class="mb-4">
                        <div class="spinner-border" role="status"
                            style="color: var(--accent-yellow); width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 1.1rem;">Loading estimates...</p>
                </div>

                <!-- Empty State -->
                <div id="pe-no-estimates" class="text-center py-5" style="display: none; padding: 3rem;">
                    <div class="mb-4">
                        <div
                            style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-yellow), var(--accent-green)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <i class="fa-solid fa-calculator" style="color: var(--text-dark); font-size: 32px;"></i>
                        </div>
                    </div>
                    <h5 style="color: var(--text-light); font-weight: 600; margin-bottom: 1rem;">No Estimates Yet</h5>
                    <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 1.1rem;">Start by creating your
                        first estimate for this project.</p>
                    <button class="btn" onclick="openEstimateEditor(projectId)"
                        style="background: linear-gradient(135deg, var(--accent-yellow), var(--accent-green)); color: var(--text-dark); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);">
                        <i class="fa-solid fa-plus me-2"></i>Create First Estimate
                    </button>
                </div>

                <!-- Estimates List -->
                <div id="pe-estimates-list" style="padding: 1.5rem;"></div>
            </div>
            <div class="modal-footer"
                style="background: var(--primary-bg); border-top: 1px solid var(--accent-yellow); border-radius: 0 0 12px 12px; padding: 1.5rem;">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="text-muted" id="pe-estimateCount" style="font-size: 0.9rem;"></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal"
                            style="border: 1px solid var(--text-muted); color: var(--text-light); padding: 8px 16px; border-radius: 6px;">
                            Close
                        </button>
                        <button class="btn" id="pe-btnCreateNew"
                            style="background: linear-gradient(135deg, var(--accent-yellow), var(--accent-green)); color: var(--text-dark); border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600;">
                            <i class="fa-solid fa-plus me-1"></i>New Estimate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        let projectId = null;

        function open(project) {
            projectId = project;
            document.getElementById('pe-projectBadge').textContent = `Project: ${project}`;
            const modal = new bootstrap.Modal(document.getElementById('projectEstimatesModal'));
            modal.show();
            loadEstimates();
        }

        async function loadEstimates() {
            try {
                showLoading(true);

                const response = await fetch(`/ProjectManager/GetProjectEstimates?projectId=${encodeURIComponent(projectId)}`);
                if (!response.ok) {
                    throw new Error(`Failed to load estimates: ${response.status}`);
                }

                const estimates = await response.json();
                console.log('Loaded estimates:', estimates);

                displayEstimates(estimates);
            } catch (error) {
                console.error('Error loading estimates:', error);
                showError('Failed to load estimates. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function displayEstimates(estimates) {
            const container = document.getElementById('pe-estimates-list');
            const noEstimates = document.getElementById('pe-no-estimates');
            const estimateCount = document.getElementById('pe-estimateCount');

            if (!estimates || estimates.length === 0) {
                container.style.display = 'none';
                noEstimates.style.display = 'block';
                estimateCount.textContent = '0 estimates';
                return;
            }

            container.style.display = 'block';
            noEstimates.style.display = 'none';
            estimateCount.textContent = `${estimates.length} estimate${estimates.length === 1 ? '' : 's'}`;

            container.innerHTML = estimates.map((estimate, index) => `
                <div class="estimate-card mb-3" style="background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%); border: 1px solid var(--accent-yellow); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                    <div class="estimate-header" style="background: linear-gradient(135deg, #F7EC59 0%, #E6D547 100%); padding: 1rem 1.5rem; display: flex; justify-content: between; align-items: center;">
                        <div class="d-flex align-items-center">
                            <div style="width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: var(--text-dark); font-weight: 600; font-size: 14px;">${index + 1}</span>
                            </div>
                            <div>
                                <h6 class="mb-0" style="color: var(--text-dark); font-weight: 600; font-size: 1.1rem;">Estimate #${index + 1}</h6>
                                <small style="color: var(--text-dark); opacity: 0.8;">Created ${formatDate(estimate.createdAt)}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="h4 mb-0" style="color: var(--text-dark); font-weight: 700;">${formatCurrency(estimate.totalAmount)}</div>
                            <span class="badge" style="background: rgba(255,255,255,0.2); color: var(--text-dark); font-size: 0.75rem; padding: 4px 8px; border-radius: 4px;">${estimate.status}</span>
                        </div>
                    </div>
                    <div class="estimate-body" style="padding: 1.5rem;">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <h6 style="color: var(--text-light); font-weight: 600; margin-bottom: 0.5rem;">Description</h6>
                                    <p style="color: var(--text-muted); margin: 0; font-size: 0.95rem;">${estimate.description || 'No description provided'}</p>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="metric">
                                            <div style="color: var(--text-muted); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Line Items</div>
                                            <div style="color: var(--accent-yellow); font-size: 1.25rem; font-weight: 600;">${estimate.lineItems?.length || 0}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric">
                                            <div style="color: var(--text-muted); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Valid Until</div>
                                            <div style="color: var(--text-light); font-size: 0.95rem; font-weight: 500;">${formatDate(estimate.validUntil)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-warning" onclick="editEstimate('${estimate.estimateId}')" style="border: 1px solid var(--accent-yellow); color: var(--accent-yellow); padding: 8px 12px; border-radius: 6px; font-weight: 500; font-size: 0.85rem;">
                                        <i class="fa-solid fa-edit me-1"></i>Edit
                                    </button>
                                    ${estimate.status === 'Draft' ? `
                                        <button class="btn btn-sm btn-outline-success" onclick="createQuoteFromEstimate('${estimate.estimateId}')" style="border: 1px solid #6BF178; color: #6BF178; padding: 8px 12px; border-radius: 6px; font-weight: 500; font-size: 0.85rem;">
                                            <i class="fa-solid fa-file-invoice me-1"></i>Create Quote
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatCurrency(amount) {
            if (!amount) return 'R 0.00';
            return 'R ' + Number(amount).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showLoading(show) {
            document.getElementById('pe-loading').style.display = show ? 'block' : 'none';
            document.getElementById('pe-estimates-list').style.display = show ? 'none' : 'block';
            document.getElementById('pe-no-estimates').style.display = 'none';
        }

        function showError(message) {
            const container = document.getElementById('pe-estimates-list');
            container.innerHTML = `
                <div class="alert" style="background: linear-gradient(135deg, var(--accent-red), #dc3545); color: var(--text-light); border: none; border-radius: 8px; padding: 1rem;">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>${message}
                </div>
            `;
            container.style.display = 'block';
        }

        // Event listeners
        document.getElementById('pe-btnCreateNew').addEventListener('click', function () {
            const modal = bootstrap.Modal.getInstance(document.getElementById('projectEstimatesModal'));
            modal.hide();
            openEstimateEditor(projectId);
        });

        // Global functions for estimate actions
        window.viewEstimateDetails = function (estimateId) {
            // Close the current modal first
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('projectEstimatesModal'));
            currentModal.hide();

            // Open the estimate editor in view-only mode
            setTimeout(() => {
                openEstimateEditor(projectId, estimateId);
            }, 300); // Small delay to ensure modal closes first
        };

        window.editEstimate = function (estimateId) {
            // Close the current modal first
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('projectEstimatesModal'));
            currentModal.hide();

            // Open the estimate editor for editing
            setTimeout(() => {
                openEstimateEditor(projectId, estimateId);
            }, 300); // Small delay to ensure modal closes first
        };

        window.createQuoteFromEstimate = async function (estimateId) {
            try {
                const response = await fetch(`/ProjectManager/CreateQuoteFromEstimate?estimateId=${encodeURIComponent(estimateId)}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Failed to create quote: ${response.status}`);
                }

                const result = await response.json();
                if (result && result.quotationId) {
                    alert('Quote created successfully!');
                    // Optionally refresh the estimates list
                    loadEstimates();
                } else {
                    throw new Error('Failed to create quote');
                }
            } catch (error) {
                console.error('Error creating quote:', error);
                alert('Failed to create quote: ' + error.message);
            }
        };

        window.openProjectEstimates = open;
    })();
</script>