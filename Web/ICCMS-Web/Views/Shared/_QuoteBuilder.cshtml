@* ============================================================
   QUOTE BUILDER MODAL (Unified AI ‚Üí Estimate ‚Üí Submit Flow)
   Inspired by Protend layout, neutral theme + TaskIt yellow accents.
   ============================================================ *@
<div class="modal fade" id="quoteBuilderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <!-- HEADER -->
      <div class="modal-header bg-light border-bottom border-warning-subtle">
        <h5 class="modal-title fw-bold text-dark">
          <i class="fas fa-helmet-safety text-warning me-2"></i> Quote Builder
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body p-4 bg-light">
        <!-- Hidden Data -->
        <input type="hidden" id="qb-projectId" />
        <input type="hidden" id="qb-clientId" />
        <input type="hidden" id="qb-contractorId" />

        <!-- Step Tabs -->
        <ul class="nav nav-tabs" id="qbTabs" role="tablist">
          <li class="nav-item">
            <button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-blueprint">1. Blueprint</button>
          </li>
          <li class="nav-item">
            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-estimate">2. Estimate</button>
          </li>
          <li class="nav-item">
            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-preview">3. Review</button>
          </li>
        </ul>

        <div class="tab-content bg-white border border-top-0 rounded-bottom p-4 shadow-sm">
          <!-- üß± STEP 1: BLUEPRINT -->
          <div class="tab-pane fade show active" id="tab-blueprint">
            <h6 class="fw-bold text-secondary mb-3">AI Blueprint Parser</h6>
            <p class="text-muted small mb-3">Upload or link a blueprint file for automatic cost estimation.</p>

            <div class="input-group mb-3">
              <input type="url" id="qb-blueprintUrl" class="form-control" placeholder="https://example.com/blueprint.pdf" />
              <button class="btn btn-outline-dark fw-bold" id="qb-btnRunAI">
                <i class="fas fa-brain me-1 text-warning"></i> Run AI Parser
              </button>
            </div>

            <div id="qb-aiProgress" class="d-none">
              <div class="spinner-border text-warning" role="status"></div>
              <span class="ms-2 text-muted">Processing blueprint with AI...</span>
            </div>

            <div id="qb-aiResult" class="mt-3 d-none alert alert-success">
              <i class="fas fa-check-circle me-2"></i> AI processing complete! You can now review and adjust the estimate.
            </div>

            <div class="mt-3 text-end">
              <button class="btn btn-warning fw-bold" onclick="goTab('#tab-estimate')">
                Next ‚Üí Estimate
              </button>
            </div>
          </div>

          <!-- üìã STEP 2: ESTIMATE -->
          <div class="tab-pane fade" id="tab-estimate">
            <h6 class="fw-bold text-secondary mb-3">Estimated Line Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered align-middle" id="qb-itemsTable">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Unit</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Line Total</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <button id="qb-btnAddItem" class="btn btn-sm btn-outline-secondary fw-bold mt-2">
              <i class="fas fa-plus me-1"></i> Add Line Item
            </button>

            <div class="mt-4 text-end">
              <button class="btn btn-secondary" onclick="goTab('#tab-blueprint')">‚Üê Back</button>
              <button class="btn btn-warning fw-bold" onclick="goTab('#tab-preview')">Next ‚Üí Review</button>
            </div>
          </div>

          <!-- üßÆ STEP 3: REVIEW + SUBMIT -->
          <div class="tab-pane fade" id="tab-preview">
            <div class="card shadow-sm border-0 mb-3">
              <div class="card-body">
              <hr class="my-3" />
              <h6 class="fw-bold text-secondary mb-3">Line Items Summary</h6>

              <div id="qb-reviewItems" class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th>
                      <th>Category</th>
                      <th>Qty</th>
                      <th>Unit Price</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

                <h6 class="fw-bold text-secondary mb-3">Totals Summary</h6>

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span>Markup (%)</span>
                  <input id="qb-markupRate" type="number" class="form-control w-auto text-end" value="20" />
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span>Tax Rate (%)</span>
                  <input id="qb-taxRate" type="number" class="form-control w-auto text-end" value="15" />
                </div>

                <hr />

                <div class="d-flex justify-content-between"><span>Subtotal:</span><strong id="qb-subtotal">R 0.00</strong></div>
                <div class="d-flex justify-content-between"><span>Tax:</span><strong id="qb-tax">R 0.00</strong></div>
                <div class="d-flex justify-content-between"><span>Grand Total:</span><strong id="qb-grandTotal" class="text-success">R 0.00</strong></div>
              </div>
            </div>

            <div class="text-end">
              <button class="btn btn-secondary" onclick="goTab('#tab-estimate')">‚Üê Back</button>
              <button class="btn btn-success fw-bold" id="qb-btnSubmit">
                <i class="fas fa-paper-plane me-1"></i> Submit Quotation
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-white border-top d-flex justify-content-between">
        <span class="text-muted small">TaskIt Quote Builder ‚Äî Integrated Construction & Maintenance System</span>
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- Toast for feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
  <div id="qb-toast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
